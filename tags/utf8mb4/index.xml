<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Utf8mb4 on I Will Survive</title>
    <link>http://blog.restartr.com/tags/utf8mb4/</link>
    <description>Recent content in Utf8mb4 on I Will Survive</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Mon, 07 Apr 2014 08:12:32 +0900</lastBuildDate>
    <atom:link href="http://blog.restartr.com/tags/utf8mb4/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>MySQLã§utf8mb4ã‚’æ‰±ã†å ´åˆã¯å¿…è¦ãªã‚«ãƒ©ãƒ ã¨æ¥ç¶šæ™‚ã ã‘æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹</title>
      <link>http://blog.restartr.com/2014/04/07/mysql-character-set-utf8mb4</link>
      <pubDate>Mon, 07 Apr 2014 08:12:32 +0900</pubDate>
      
      <guid>http://blog.restartr.com/2014/04/07/mysql-character-set-utf8mb4</guid>
      <description>

&lt;p&gt;çµè«–ã¯ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã€‚&lt;/p&gt;

&lt;h2 id=&#34;ã¾ã¨ã‚:92573dc8333c8459780952b1c4bbdcda&#34;&gt;ã¾ã¨ã‚&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;systemã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒ&lt;code&gt;character_set_system&lt;/code&gt;ã«åæ˜ ã•ã‚Œã‚‹. clientã®æ¥ç¶šæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã‚‹ï¼ˆæœªæ¤œè¨¼ï¼‰&lt;/li&gt;
&lt;li&gt;clientã®æ¥ç¶šæ™‚ã®æŒ‡å®šãŒå„ªå…ˆã•ã‚Œã‚‹ã€‚ãŸã ã—ã€&lt;code&gt;character_set_database&lt;/code&gt;, &lt;code&gt;character_set_filesystem&lt;/code&gt;, &lt;code&gt;character_set_server&lt;/code&gt;ã«ã¤ã„ã¦ã¯ä¸Šæ›¸ãã•ã‚Œãªã„ã€‚&lt;/li&gt;
&lt;li&gt;my.cnfã®&lt;code&gt;mysql.default-character-set&lt;/code&gt;ã¯æ„å‘³ã‚ã‚‹ï¼Ÿï¼ˆæœªæ¤œè¨¼ï¼‰&lt;/li&gt;
&lt;li&gt;my.cnfã®&lt;code&gt;mysqld.character-set-server&lt;/code&gt;ã¯filesystemã¨systemä»¥å¤–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å½±éŸ¿ã™ã‚‹ã€‚clientã®æ¥ç¶šæ™‚ã«ç„¡æŒ‡å®šã®å ´åˆã«ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»¥ä¸‹ã®ç†ç”±ã«ã‚ˆã£ã¦ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯utf8ã§ã€å¿…è¦ãªã‚«ãƒ©ãƒ ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥ç¶šæ™‚ã«ã ã‘utf8mb4ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã¨ã—ãŸã€‚&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ä½¿ãˆã‚‹æ–‡å­—æ•°ãŒutf8ã ã¨255æ–‡å­—ã¾ã§ã«å¯¾ã—ã¦utf8mb4ã ã¨191æ–‡å­—ã¾ã§ã€‚

&lt;ul&gt;
&lt;li&gt;ã‚µãƒ¼ãƒãƒ¼å´ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆutf8.ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆutf8mb4.ãŒè‰¯ã„&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;æ¤œè¨¼:92573dc8333c8459780952b1c4bbdcda&#34;&gt;æ¤œè¨¼&lt;/h3&gt;

&lt;p&gt;server/clientã¨ã‚‚ã«remiã®MySQL5.5ã‚’ä½¿ç”¨&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql --version
mysql  Ver 14.14 Distrib 5.5.37, for Linux (x86_64) using readline 5.1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;utf8ãªã‚«ãƒ©ãƒ &lt;code&gt;name1&lt;/code&gt;ã¨ã€utf8mb4ãªã‚«ãƒ©ãƒ &lt;code&gt;name2&lt;/code&gt;ã‚’ç”¨æ„.&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;show create table user2\G&#39;
*************************** 1. row ***************************
       Table: user2
Create Table: CREATE TABLE `user2` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name1` varchar(255) DEFAULT NULL,
  `name2` varchar(255) CHARACTER SET utf8mb4 DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;show global variables like &amp;quot;character_set%&amp;quot;; show variables like &amp;quot;character_set%&amp;quot;&#39;
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | latin1                     |
| character_set_connection | latin1                     |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | latin1                     |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;clientãŒ&lt;code&gt;--default-character-set=utf8mb4&lt;/code&gt;ã‚’ã¤ã‘ã¦æ¥ç¶šã—ãŸå ´åˆ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql --default-character-set=utf8 -uroot test -e &#39;show global variables like &amp;quot;character_set%&amp;quot;; show variables like &amp;quot;character_set%&amp;quot;&#39;
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | latin1                     |
| character_set_connection | latin1                     |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | latin1                     |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;my.cnfã«&lt;code&gt;mysql.default-character-set&lt;/code&gt;ã‚’æŒ‡å®šã—ãŸå ´åˆ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[mysql]
default-character-set=utf8
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;show global variables like &amp;quot;character_set%&amp;quot;; show variables like &amp;quot;character_set%&amp;quot;&#39;
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | latin1                     |
| character_set_connection | latin1                     |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | latin1                     |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | latin1                     |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | latin1                     |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;my.cnfã«&lt;code&gt;mysqd.character-set-server=utf8&lt;/code&gt;ã‚’æŒ‡å®šã—ãŸå ´åˆ&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-ini&#34;&gt;[mysqld]
character-set-server=utf8
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;show global variables like &amp;quot;character_set%&amp;quot;; show variables like &amp;quot;character_set%&amp;quot;&#39;
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | utf8                       |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | utf8                       |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | utf8                       |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | utf8                       |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;rails-activerecord-ã‹ã‚‰æ¥ç¶šã™ã‚‹å ´åˆ:92573dc8333c8459780952b1c4bbdcda&#34;&gt;Railsï¼ˆActiveRecordï¼‰ã‹ã‚‰æ¥ç¶šã™ã‚‹å ´åˆã€€&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;db:
  encoding: &amp;quot;utf8mb4&amp;quot; # SET NAMES &amp;quot;utf8mb4&amp;quot;ã¨ç­‰ä¾¡
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ã•ã‚‰ã«ã€&lt;code&gt;SET NAMES utf8mb4&lt;/code&gt;ã¯ä»¥ä¸‹å…¨ã¦ã‚’å®Ÿè¡Œã—ãŸå ´åˆã¨ç­‰ä¾¡&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sql&#34;&gt;SET character_set_client = utf8mb4;
SET character_set_results = utf8mb4;
SET character_set_connection = utf8mb4;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;utf8ãªã‚«ãƒ©ãƒ ã®æ–‡å­—åˆ—æ¤œç´¢:92573dc8333c8459780952b1c4bbdcda&#34;&gt;utf8ãªã‚«ãƒ©ãƒ ã®æ–‡å­—åˆ—æ¤œç´¢&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;utf8mb4ãªã‚«ãƒ©ãƒ ã«ã¯ã€utf8mb4ã§æ¥ç¶šã—ã¦insertã™ã‚‹ã“ã¨&lt;/li&gt;
&lt;li&gt;utf8ãªã‚«ãƒ©ãƒ ã«ã¯ã€utf8ã§ã‚‚utf8mb4ã§ã‚‚ã©ã¡ã‚‰ã§insertã—ã¦ã‚‚selectã—ã¦ã‚‚å•é¡Œãªã„&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;set names &amp;quot;utf8mb4&amp;quot;; select * from user2 where name2 like &amp;quot;%ã ã‚ˆ%&amp;quot; limit 3&#39;
+----+----------------+------------------+
| id | name1          | name2            |
+----+----------------+------------------+
|  1 | firstã ã‚ˆâ™¬     | firstã ã‚ˆâ™¬       |
|  2 | secondã ã‚ˆ     | secondã ã‚ˆ????   |
|  3 | secondã ã‚ˆ?    | secondã ã‚ˆâ™¨      |
+----+----------------+------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;set names &amp;quot;utf8mb4&amp;quot;; select * from user2 where name2 like &amp;quot;%ã ã‚ˆâ™¨&amp;quot; limit 3&#39;
+----+--------------------+---------------------+
| id | name1              | name2               |
+----+--------------------+---------------------+
|  3 | secondã ã‚ˆ?        | secondã ã‚ˆâ™¨          |
|  8 | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¬        | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¨          |
| 13 | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¬        | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¨          |
+----+--------------------+---------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ãŸã ã—ã€utf8mb4ãªã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦4ãƒã‚¤ãƒˆæ–‡å­—åˆ—ã‚’æŠ•ã’ã‚‹ã¨ã€utf8ã§æ¥ç¶šã—ãŸæ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;set names &amp;quot;utf8&amp;quot;; select * from user2 where name2 like &amp;quot;%ã ã‚ˆâ™¨&amp;quot; limit 3&#39;
ERROR 1267 (HY000) at line 1: Illegal mix of collations (utf8mb4_general_ci,IMPLICIT) and (utf8_general_ci,COERCIBLE) for operation &#39;like&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ãªã®ã§ã€ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦utf8mb4ãŒæ ¼ç´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹DBã«å¯¾ã—ã¦ã¯ã€utf8mb4ã§å¿…ãšæ¥ç¶šã™ã‚‹ã“ã¨ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -uroot test -e &#39;set names &amp;quot;utf8mb4&amp;quot;; select * from user2 where name2 like &amp;quot;%ã ã‚ˆâ™¨&amp;quot; limit 3&#39;
+----+--------------------+---------------------+
| id | name1              | name2               |
+----+--------------------+---------------------+
|  3 | secondã ã‚ˆ?        | secondã ã‚ˆâ™¨          |
|  8 | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¬        | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¨          |
| 13 | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¬        | ãƒ†ã‚¹ãƒˆã ã‚ˆâ™¨          |
+----+--------------------+---------------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ5-1ã®å ´åˆ:92573dc8333c8459780952b1c4bbdcda&#34;&gt;ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ5.1ã®å ´åˆ&lt;/h3&gt;

&lt;p&gt;my.cnfã‚„mysqlã‚³ãƒãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«&lt;code&gt;client.default_character_set=utf8mb4&lt;/code&gt;ã¯æŒ‡å®šã§ããªã„&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql --default-character-set=utf8mb4 -h 192.168.1.164 -uroot test -e &#39;select * from user&#39;
mysql: Character set &#39;utf8mb4&#39; is not a compiled character set and is not specified in the &#39;/usr/share/mysql/charsets/Index.xml&#39; file
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ãŸã ã—ã€SQLã§ã®&lt;code&gt;set names utf8mb4&lt;/code&gt;ã®æŒ‡å®šã¯æœ‰åŠ¹ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ mysql -h 192.168.1.164 -uroot test -e &#39;set names utf8mb4; select * from user&#39;
+----+------------+---------------+
| id | name1      | name2         |
+----+------------+---------------+
| 14 | ãƒ†ã‚¹ãƒˆ  | ãƒ†ã‚¹ãƒˆ???? |
| 15 | ãƒ†ã‚¹ãƒˆ? | ãƒ†ã‚¹ãƒˆâ™¨ |
+----+------------+---------------+
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ActiveRecordç­‰ã§mysql2ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€encodingã«utf8mb4ã‚’æŒ‡å®šã™ã‚‹ã¨ä¾‹å¤–ãŒèµ·ãã‚‹&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;Character set &#39;utf8mb4&#39; is not a compiled character set and is not specified in the &#39;/usr/share/mysql/charsets/Index.xml&#39; file
/home/yoshida/hoge/vendor/bundle/ruby/2.0.0/gems/mysql2-0.3.13/lib/mysql2/client.rb:58:in `connect&#39;: Can&#39;t initialize character set utf8mb4 (path: /usr/share/mysql/charsets/) (Mysql2::Error)
        from /home/yoshida/hoge/vendor/bundle/ruby/2.0.0/gems/mysql2-0.3.13/lib/mysql2/client.rb:58:in `initialize&#39;
        from test_mysql.rb:3:in `new&#39;
        from test_mysql.rb:3:in `&amp;lt;main&amp;gt;&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ãªã®ã§ã€æ¥ç¶šæ™‚ã«set namesã™ã‚Œã°è‰¯ã„&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;require &#39;mysql2&#39;
client = Mysql2::Client.new(:host =&amp;gt; &amp;quot;localhost&amp;quot;, :username =&amp;gt; &amp;quot;root&amp;quot;, db: &#39;test&#39;)
client.query(&#39;SET NAMES utf8mb4&#39;)
puts client.query(&#39;SELECT * FROM user&#39;).map { |r| r[&#39;name2&#39;] }
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ruby test.rb
[&amp;quot;ãƒ†ã‚¹ãƒˆ????&amp;quot;, &amp;quot;ãƒ†ã‚¹ãƒˆğŸŒ¸&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;å‚è€ƒ:92573dc8333c8459780952b1c4bbdcda&#34;&gt;å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://dev.mysql.com/doc/refman/5.1/ja/charset-database.html&#34;&gt;MySQL ::   MySQL 5.1 ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ« :: 9.3.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ã‚»ãƒƒãƒˆãŠã‚ˆã³ç…§åˆé †åº&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://d.hatena.ne.jp/maeyan/20090811/1250008156&#34;&gt;MySQLã§utf8ã‚’æ‰±ã†å ´åˆã€‚ - Ã—Ã—Ã—Diary&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://apps.timwhitlock.info/emoji/tables/unicode&#34;&gt;Emoji unicode characters for use on the web&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>
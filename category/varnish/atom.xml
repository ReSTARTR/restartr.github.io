<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: varnish | I Will Survive]]></title>
  <link href="http://blog.restartr.com/category/varnish/atom.xml" rel="self"/>
  <link href="http://blog.restartr.com/"/>
  <updated>2015-12-31T20:23:32+09:00</updated>
  <id>http://blog.restartr.com/</id>
  <author>
    <name><![CDATA[ReSTARTR]]></name>
    <email><![CDATA[yoshida.masaki+restartr@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[VarnishのVCLを再起動なしに再読み込みする]]></title>
    <link href="http://blog.restartr.com/2014/04/06/reload-varnish-vcl/"/>
    <updated>2014-04-06T15:38:08+09:00</updated>
    <id>http://blog.restartr.com/2014/04/06/reload-varnish-vcl</id>
    <content type="html"><![CDATA[<p>/etc/varnish/default.vclを書き換えた時、</p>

<p><code>bash
/etc/init.d/varnishd restart
</code></p>

<p>ってやってたけど、reloadできることを今更知った。</p>

<h3 id="vcllist-vcl">vcl.list: 現在の読み込んでるVCLの一覧を見る</h3>

<p>CentOSのyumで入れたvarnishはデフォルトでこんなふうになってる</p>

<p><code>bash
$ varnishadm -T localhost:6082 vcl.list
active        579 boot
</code></p>

<h3 id="vclload-vcl">vcl.load: 新規にVCLをロードする</h3>

<p><code>bash
$ varnishadm -T localhost:6082 vcl.load boot-`date+%Y%m%d%H%M%S` /etc/varnish/default.vcl
VCL compiled.
</code></p>

<p>この時点では利用可能な状態であって、まだ変更は反映されていない</p>

<p><code>bash
$ varnishadm -T localhost:6082 vcl.list
active        579 boot
available       0 boot-20140406153127
</code></p>

<h3 id="vcluse-vcl">vcl.use: ロードしたVCLに切り替える</h3>

<p>```bash
$ varnishadm -T localhost:6082 vcl.use boot-20140406153127</p>

<p>```
何も表示されないけどちゃんと切り替わっている</p>

<p><code>bash
$ varnishadm -T localhost:6082 vcl.list
available     526 boot
active         53 boot-20140406153127
</code></p>

<p>ちなみに、真ん中の数値はactiveの場合は経過秒数で、availableになると数値が減っていく。
でも、0になっても居座り続ける。この数値の変化のルールはよくわかってない。</p>

<p>ということで不要な過去のvclは定期的に消さないとずっと残り続けてしまうので注意。</p>

<h3 id="vcldiscard-vcl">vcl.discard: ロード済みvclの破棄</h3>

<p>```bash
$ varnishadm -T localhost:6082 vcl.discard boot</p>

<p>```</p>

<p>ここでも結果が表示されないけどちゃんと消えている。</p>

<p><code>bash
$ varnishadm -T localhost:6082 vcl.list
available       11 boot-20140406155155
</code></p>

<p>本当はinitスクリプト化すると便利なんだろうけど、手動でも良いかなと。</p>

<ul>
  <li><a href="http://blog.xcir.net/?p=124">Varnishで再起動無しで設定ファイルを適用する方法(reload) » cat /dev/random &gt; /dev/null &amp;</a></li>
</ul>
]]></content>
  </entry>
  
</feed>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>I Will Servive</title>
  <meta name="author" content="ReSTARTR">

  
  <meta name="description" content="入門 自然言語処理は11月に購入してから寝かせたままでしたが、本日より読み始めることにしました。 本日は第一章です。内容は大きく以下2点。 pythonとnltkでの簡単なテキスト処理方法
自然言語処理を俯瞰する 内容は本に任せるとして、ここでは演習問題の解答をしようと思います。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.restartr.com/blog/page/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="I Will Servive" type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>


	<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$$','$$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-894530-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <style>html{background: url("/images/background.png") no-repeat center center fixed;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.restartr.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/02/13/analysing-text-with-the-natual-language-toolkit-chap1/">入門 自然言語処理 第一章</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-13T09:00:29+09:00" pubdate data-updated="true">2011-02-13 (Sun)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/dp/4873114705/">入門 自然言語処理</a>は11月に購入してから寝かせたままでしたが、本日より読み始めることにしました。</p>

<p>本日は第一章です。内容は大きく以下2点。</p>

<ul>
<li>pythonとnltkでの簡単なテキスト処理方法</li>
<li>自然言語処理を俯瞰する</li>
</ul>
<p>内容は本に任せるとして、ここでは演習問題の解答をしようと思います。</p>

<p><a id="more"></a><a id="more-588"></a></p>

<p>問題文は簡潔に記述するため、本書に記載されているものとは異なる表記をしています。</p>

<h3>納得いかない問題</h3>
<p>ひとつだけ納得いかない問題がありました。
「<i>17. text9からtext.9.index()を使って’sunset’を含む一文を抜き出す</i>」です。</p>

<p>解答をググっても、こちらしか出てこず。
<a href="http://sojin.kyoto-math.jp/nlp/1-3.html#id1">1-15. bで始まる単語抽出 — 入門自然言語処理</a></p>

<p>たしかに、</p>

<pre class="brush:python">
&gt;&gt;&gt; text9.index('sunset')
629
</pre>
<p>と帰ってきます。でも、実際には’sunset’を含む一文は複数あるわけです。
確認するとこんな感じ。</p>

<pre class="brush:python">
&gt;&gt;&gt; [t for t in text9 if t=='sunset']
['sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset', 'sunset']
</pre>
<p>複数ある一文を抽出しなくていいの？という疑問が出てきました。すべての文を抽出する方法はさておき、今回はひとつだけ抽出する解答だけを書きました。</p>

<h3>演習問題</h3>
<h4>準備</h4>
<p>nltkとmatplotlibがインポートできていれば、以下コードだけですみます。</p>

<pre class="brush:python">from nltk.book import *</pre>
<p>以下が、すべての問題の解答です。
(私個人の解答であり、正解の保証はどこにもありません。）</p>

<h4>1. Pythonインタプリタを電卓として、12 / (4 + 1)のような計算を入力してみよう</h4>
<pre class="brush:python">&gt;&gt;&gt; 12 / 4 + 1
2.3999999999999999</pre>
<h4>2. 26文字のアルファベットが与えられたとき、10字の文字列は26の10乗（あるいは26**10）種類も作ることができるが、100文字だったら何種類か。</h4>
<pre class="brush:python">&gt;&gt;&gt; 26 ** 100
3142930641582938830174357788501626427282669988762475256374173175398995908420104023465432599069702289330964075081611719197835869803511992549376L</pre>
<h4>3. [&#8216;Monty&#8217;, &#8216;Python&#8217;] * 20や 3 * sent1を実行すると何が起こるか</h4>
<pre class="brush:python">&gt;&gt;&gt; ['Monty', 'Python'] * 3
['Monty', 'Python', 'Monty', 'Python', 'Monty', 'Python']</pre>
<h4>4. text2には単語がいくつ含まれているか。また重複を除くといくつか。</h4>
<pre class="brush:python">&gt;&gt;&gt; #単語数
&gt;&gt;&gt; len(text2)
141576
&gt;&gt;&gt; #重複除いた単語数
&gt;&gt;&gt; len(set(text2))
6833</pre>
<h4>5. ユーモア小説とロマンス小説の間で、どちらが語彙の多様性が高いか。</h4>
<ul>
<li>ユーモア小説：多様性＝6.9</li>
<li>ロマンス小説：多様性＝8.3</li>
</ul>
<p>?ロマンス小説が高い。</p>

<h4>6. Sense and Sensibilityのなかで、エリナ、マリアン、エドワード、ウィロビーの分散プロットを表示してみよう。</h4>
<p>名前まで日本語表記されていて元の綴りがわからない…
なのでまず探すところから。</p>

<pre class="brush:python">&gt;&gt;&gt;[t for t in set(text2) if t.startswith('El')]
['Elinor', 'Eliza']</pre>
<p>な感じで4人分探します。
で、プロットする</p>

<pre class="brush:python">&gt;&gt;&gt; text2.dispersion_plot(['Elinor', 'Mrianne', 'Edward', 'Willoughbys'])
# ※ここでプロットウインドウが表示される
</pre>
<h5>男女の役割の違い</h5>
<p>女性が高頻度に出現</p>

<h5>カップルの特定は可能か</h5>
<p>できない。どうしろと…</p>

<h4>7. text5のコロケーションを探してみよう。</h4>
<pre class="brush:python">&gt;&gt;&gt; text5.collocations()
Building collocations list
wanna chat; PART JOIN; MODE #14-19teens; JOIN PART; PART PART;
cute.-ass MP3; MP3 player; JOIN JOIN; times .. .; ACTION watches; guys
wanna; song lasts; last night; ACTION sits; -...)...- S.M.R.; Lime
Player; Player 12%; dont know; lez gurls; long time</pre>
<h4>8. len(set(text4))の目的</h4>
<p>単語のユニーク数を求める</p>

<h4>9. リストと文字列</h4>
<h5>(a) 変数の定義と2種類の出力を試してみよう</h5>
<pre class="brush:python">&gt;&gt;&gt; my_string = 'My String'
&gt;&gt;&gt; my_string
My String
&gt;&gt;&gt; print my_string
My String
</pre>
<h5>(b). 連結と演算</h5>
<pre class="brush:python">&gt;&gt;&gt; my_string + my_string 
'My StringMyString'
&gt;&gt;&gt; my_string * 3 
'My StringMy StringMy String'
</pre>
<h4>10. 単語のリストを保持するmy_sentという変数を定義しよう</h4>
<h5>(a) &#8217; &#8216;.joiin(my_sent)を使ってリストを文字列に変換してみよう。</h5>
<pre class="brush:python">&gt;&gt;&gt; ' '.join(my_string.split(' '))
'My String'
</pre>
<h5>(b) split()を使ってできた</h5>
<pre class="brush:python">&gt;&gt;&gt; my_sent = ['My', 'Sent']
&gt;&gt;&gt; ' '.join(my_sent)
'My Sent'
&gt;&gt;&gt; ' '.join('hoge moge'.split(' '))
'My Sent'
</pre>
<h4>11. リストの連結</h4>
<pre class="brush:python">&gt;&gt;&gt; phrase1 = ['hoge']
&gt;&gt;&gt; phrase1 += ['moge']
&gt;&gt;&gt; phrase2 = ['foo']
&gt;&gt;&gt; phrase2 += ['bar']
&gt;&gt;&gt; phrase1 + phrase2
['hoge', 'moge', 'foo', 'bar']</pre>
<h5>len(phrase1 + phrase2)とlen(phrase1) + len(phrase2)の違いはなにか。</h5>
<p>連結した後の長さと、それぞれの長さの加算</p>

<h4>12. NLPと関連あるものはどれか。</h4>
<ul>
<li>[&#8216;Monty Python&#8217;][6:12]</li>
<li>[&#8216;Monty&#8217;, &#8216;Python&#8217;][1]</li>
</ul>
<p>?b</p>

<h4>13. sent1[2][2]はなにを表しているだろうか。</h4>
<p>2要素目の2文字目</p>

<h4>14.  要素のインデックス取得</h4>
<p>微妙だけど。</p>

<pre class="brush:python">&gt;&gt;&gt; i = 0
&gt;&gt;&gt; for t in sent3:
...   if t=='the':
...     print i
...   i += 1
...
1
5
8</pre>
<h4>15. bから始まる単語の取得</h4>
<pre class="brush:python">&gt;&gt;&gt; sorted(set([t for t in text5 if t.startswith('b')]))
['b', 'b-day', 'b/c', 'b4',......</pre>
<h4>16. range()について</h4>
<pre class="brush:python">&gt;&gt;&gt; range(10)
[1,2,3....9]
&gt;&gt;&gt; range(10,20)
[10,11,12,...., 20]
&gt;&gt;&gt; range(10,20,2)
[10, 12, ..., 18]
&gt;&gt;&gt; range(20,10,-2)
[20, 18, ..., 12]</pre>
<h4>17. text9からtext.9.index()を使って&#8217;sunset&#8217;を含む一文を抜き出す</h4>
<p>これで良いのかわかりませんが、ひとまずの解答として。</p>

<pre class="brush:python">
dot_pre = 0 # 直前の'.'の位置
dot_aft = 0 # 直後の'.'の位置
found = False # '.'が見つかったかどうか
i = 0 # 現在位置
for t in text9:
  if t=='sunset':
    found = True
  if t=='.':
    if found==True:
      dot_aft = i
      break
    else:
      dot_pre = i
  i += 1
# 'sunset'を含む一文を生成する。
' '.join([text9[t] for t in range(dot_pre+1, dot_aft+1)])
# 'CHAPTER I THE TWO POETS OF SAFFRON PARK THE suburb of Saffron Park lay on the sunset side of London , as red and ragged as a cloud of sunset .'
</pre>
<h4>18. sent1からsent8までに含まれる語彙を計算</h4>
<pre class="brush:python">len(set(sent1 + sent2 + sent3 + sent4 + sent5 + sent6 + sent7 + sent8))</pre>
<h4>19. 以下2行の違いは何か。</h4>
<pre class="brush:python">sorted(set([w.lower() for w in text1]))
sorted([w.lower() for w in set(text1)])</pre>
<h5>sorted(set([w.lower() for w in text1]))</h5>
<p>小文字のリストを作ってからユニークにしてソート</p>

<h5>sorted([w.lower() for w in set(text1)])</h5>
<p>ユニークリストから小文字にしてソート
こちらが大きい。重複をふくんでいるので。</p>

<h4>20. w.isupper()とw.islower()の違いは何か</h4>
<p>大文字ならTrueと小文字ならTrue</p>

<h4>21. 最後の2単語を取り出すスライス式を書いてみよう。</h4>
<pre class="brush:python">&gt;&gt;&gt; text2[-2:]
</pre>
<h4>21. 4文字の単語のうち、頻度の高い順に取得してみよう。</h4>
<pre class="brush:python">
&gt;&gt;&gt; FreqDist([t for t in text4 if len(t)==4]).keys()
</pre>
<h4>21. 大文字の単語を一行ずつ表示</h4>
<pre class="brush:python">
&gt;&gt;&gt;  for str in [t for t in text6 if t.isupper()]:
&gt;&gt;&gt;   print str
</pre>
<h4>24. 条件にあったものを含むリスト</h4>
<h5>a: izeで終わる</h5>
<pre class="brush:python">[t for t in text6 if t.endswith('ize')]</pre>
<h5>b: zを含む</h5>
<pre class="brush:python">[t for t in text6 if 'z' in t]</pre>
<h5>c: ptを含む</h5>
<pre class="brush:python">[t for t in text6 if 'pt' in t]</pre>
<h5>d: 先頭大文字あと小文字（＝タイトルケース)</h5>
<pre class="brush:python">[t for t in text6 if t.isalpha()==True and t==t.title()]</pre>
<h4>25. listed = [&#8216;she&#8217;, &#8216;sells&#8217;, &#8216;sea&#8217;, &#8216;shells&#8217;, &#8216;by&#8217;, &#8216;the&#8217;, &#8216;sea&#8217;, &#8216;shore&#8217;]</h4>
<h4 />
<h5>shではじまる単語</h5>
<pre class="brush:python">[t for t in listed if t.startswith('sh')]</pre>
<h5>4文字より大きい単語</h5>
<pre class="brush:python">[t for t in listed if len(t)&gt;=4]</pre>
<h4>26. sum([len(w) for w in text1])について</h4>
<h5>どんな処理？</h5>
<p>リスト中のすべての単語長の合計</p>

<h5>これをつかって平均はだせる？</h5>
<pre class="brush:python">
&gt;&gt;&gt; sum([len(w) for w in text1])/len(text1)
3.8304111280236488</pre>
<h4>27. 語彙サイズを返すvocab_size(text)を定義</h4>
<pre class="brush:python">
&gt;&gt;&gt; def vocab_size(text):
...  return len(set(text))
...
&gt;&gt;&gt; vocab(text1)
19317
</pre>
<h4>28. percent(word, text)を定義</h4>
<pre class="brush:python">
&gt;&gt;&gt; def percent(word, text):
...  return len([t for t in text if t==word]) / len(text)
</pre>
<h4>29. set(sent3) &lt; set(text1)について</h4>
<h5>実行してみる</h5>
<pre class="brush:python">True</pre>
<h5>29. 異なるテキストで実行して何が起こるか</h5>
<pre class="brush:python">&gt;&gt;&gt; set(sent3) &lt; set(text3)
True</pre>
<h5>実用的な応用は何があるか</h5>
<p>ドキュメント間の語彙数の比較</p>

<ul>
  <li><a href="http://www.amazon.co.jp/dp/4873114705">入門 自然言語処理 [大型本]</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/02/07/automatically-close-the-file-in-python-and-scala/">Pythonとscalaのファイルの自動クローズ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-07T00:10:22+09:00" pubdate data-updated="true">2011-02-07 (Mon)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>エキスパートPythonプログラミングを少しずつ読み進めています。といっても気になるタイトルを拾い読みですが。</p>

<p>そのなかの”2.4 withとcontextlib”の章のwith文の例としてファイル読み込みのコードが書いてました。
<script src="https://gist.github.com/813385.js?file=read_file_using_with.py"></script>
たったこれだけで、自動クローズまでやってくれるみたい。</p>

<p><a id="more"></a><a id="more-576"></a>
さらに、with文を使うためのクラス定義も可能らしい。
<script src="https://gist.github.com/813385.js?file=Reader.py"></script></p>

<p>実装すべきは下記２メソッドのみ。</p>

<ul>
<li>__enter__(self)</li>
<li>__exit__(self, exception_type, exception_value, exception_traceback)</li>
</ul>
<p>__enter__の戻り値はasで受けとれます。
__exit__で例外処理のfinallyに当たる処理を書きます。何も返さないと例外はその呼び出し元に伝播します。</p>

<p>さらにさらに、contextlibというモジュールを使えば、もっと自然に書けます。
<script src="https://gist.github.com/813385.js?file=read_file_with_closing.py"></script>
※これは、contextmanager内のfinally句でcloseを書くのと同じ。(<a href="http://www.python.jp/doc/nightly/library/contextlib.html#contextlib.closing">参考</a>)</p>

<h4>Scalaでwith（っぽいもの）を実装</h4>
<p>pythonのwith文と同様の記述方法をScalaでやるとしたら…こんな感じでしょうか。
<script src="https://gist.github.com/813385.js?file=FileReader.scala"></script></p>

<p>ファイルの自動クローズについてはこちらを参考にさせていただきました。</p>

<ul>
  <li><a href="http://d.hatena.ne.jp/syttru/20080322/1206212125">Scalaでファイル操作 - syttruの日記</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/02/06/introduction-of-data-mining-without-formul/">数式を使わないデータマイニング入門</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-06T22:47:11+09:00" pubdate data-updated="true">2011-02-06 (Sun)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
  <li><a href="http://www.amazon.co.jp/dp/4334033555">数式を使わないデータマイニング入門 隠れた法則を発見する (光文社新書) [新書]</a></li>
</ul>

<p>テキストマイニング書を探していたら、なぜか同じ場所にあったので買いました。</p>

<p>データマイニングって何？という人向けの入門書。１時間もあればサクっと読める軽い内容。データマイニングをはじめる人だけでなく、<strong>データマイニングを依頼する側</strong>が読むと良いのではないでしょうか。</p>

<p><a id="more"></a><a id="more-564"></a></p>

<h4>マイニング＝採鉱</h4>
<p>第一章にも書いてあるけど、</p>

<blockquote><em>マイニングとは、「採鉱」を指す言葉である。データマイニングにおけるマイニングは二段階のプロセスに分かれる。
一段階目は、大量の情報から隠れた法則を見つけ出すこと。
〜中略〜
二段階目は、そこで見つかった法則のなかから、使えるものを探し出すこと。これは意外に認知されていない。</em>

</blockquote>
<p>さらに、</p>

<blockquote><em>多くの人は法則さえ見つかれば、それが有意で、お金にもなると考えている。しかし、実際には役に立たない法則の方が多い。この事実は見過ごされがちだ。</em>
</blockquote>
<p>マイニングを行えば、何かしら答えが見つかるものだと思われがち。結果的に答えが見つかればラッキー。データマイニングを依頼する側には「期待せずに期待してください」としか言えないですね…</p>

<p>ところで、何かしら答えを限られた期間で見つけ出すのは難しいのだとすれば、データ分析者は評価者に対して目標として何をコミットし、どのように結果を評価されるのでしょうか。プログラマーと同じく、明確な数値目標を設定しづらい職業なのかなと思ったり。</p>

<h4>監視社会</h4>
<p>本書中盤にはデータマイニング手法としていくつか概要の説明があり、最後には監視社会について触れています。それまでの流れと少し関連性が低い内容ではあるけれど、興味深い内容。参考図書として挙げられていたもの（下記）が１０年前の書籍なので、関連する最近の書籍をさがしてみる予定。</p>

<ul>
  <li><a href="http://www.amazon.co.jp/dp/4791760085">監視社会 [単行本]</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/30/how-to-start-learning-python-programming/">Pythonをはじめるために</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-30T22:04:12+09:00" pubdate data-updated="true">2011-01-30 (Sun)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://blog.restartr.com/2011/01/10/6-targets-i-want-to-achieve-in-2011/">今年の目標</a>として</p>
<blockquote><p>3.pythonに手を出す</p></blockquote>
<p>というのを掲げていて、「エキスパートPythonプログラミング」を買ったので、pythonの学習をこんな感じではじめてみるつもり、というのを書いておきます。</p>

<ul>
  <li><a href="http://www.amazon.co.jp/dp/4048686291">エキスパートPythonプログラミング</a></li>
</ul>

<p><a id="more"></a><a id="more-544"></a>&lt;/p&gt;</p>
<h3>1.リファレンスを用意する</h3>
<ul>
<li>基礎文法：<a href="http://www.python.jp/doc/release/reference/">Python 言語リファレンス &mdash; Python v2.6.2 documentation</a></li>
<li>チュートリアル：<a href="http://www.python.jp/doc/release/tutorial/index.html">Python チュートリアル &mdash; Python v2.6.2 documentation</a></li>
<li>痒いところ向け：エキスパートPythonプログラミング</li>
<li>PHPから逆引き：<a href="http://www.php2python.com/">Php2Python - Python alternatives to PHP functions, classes and librarie</a>

<p>基礎文法は公式リファレンスで大体まかなえますし、ググれば大体の情報は手に入るので、あえて購入していません。オライリーの「初めてのpython 第3版」は古い上にゴツイので却下しました。（「初めてのpython第4版が洋書は最近出ましたが日本語訳はまだ）</p>
<p>PHP2Pythonは、PHP関数をPythonに置き換えると…というのを投稿できるサイトです。PHP関数から逆引きできるので、目的がはっきりしていれば探しやすくてかなり便利です。</p>
<h3>2.目標を決める</h3>
<p>pythonを学び始めるにあたっては、何をどこまで学ぶのか、というのは明確にすべきでしょう。<br />
私の場合は、こんな感じ。</p>
<h4>他言語との違いを探る</h4>
<p>新しい言語を学んだほうが良いというのはよく言われるところだと思います。たとえ直接的に必要性がなくても。その言語やコミュニティの特徴を知ることで、新しい視点が生まれます。<br />
普段のプログラミングに良い部分を取り入れることができると期待しています。</p>
<p><b>python界隈で知りたいこと</b><br />
その言語に求めるものは、言語毎に異なるもの。私が気になっているのは以下のとおり。</p>
<ul>
<li>オブジェクト指向プログラミング</li>
<li>関数型プログラミング</li>
<li>アプリ開発フロー
<li>
<li>アジャイルへの取り組みやテスト手法</li>
<li>メタプログラミング</li>

<p>これを知るために最適だったのが、上述の「エキスパートPythonプログラミング」でした。</p>
<p>また、特定の目的も一応あって、以下の２つを予定しています。</p>
<p><b>自然言語処理入門</b><br />
積読中の書籍に「入門　自然言語処理」があるのですが、pythonで解説されていますので、コードでつまづかない程度に基礎体力をつけておきます。<br />

* [入門　自然言語処理](http://amazon.co.jp/dp/4873114705)

必要そうな技術はこんな感じ。</p>
<ul>
<li>文字列の取り扱い</li>
<li>NLTK(pythonの言語処理モジュール)の取り扱い</li>
<li>統計処理ライブラリの取り扱い</li>
</ul>
<p><b>GAEアプリ開発</b><br />
Scalaでも少し手をつけていたりますが、JMV系とPythonでどのような違いがあるのかも見てみたいところ。</p>
<ul>
<li>Webフレームワーク(Django, Kay等)の取り扱い</li>
<li>連携する各サービスAPIの取り扱い</li>
</ul>
<p>当分は言語仕様と戯れようと思います。</p>
</li></li></ul></li></ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/16/talk-session-what-is-programming-for-developing-a-good-software/">トークセッション「よいソフトウェアを作るプログラミングとは」</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-16T00:40:01+09:00" pubdate data-updated="true">2011-01-16 (Sun)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>昨日<a href="http://blog.restartr.com/2011/01/15/97things-every-programmers-should-know/">感想をブログった</a>「<a href="http://www.amazon.co.jp/dp/4873114799">プログラマが知るべき９７のこと</a>」刊行記念のトークセッションに行ってきました。タイトルは「よいソフトウェアを作るプログラミングとは」です。<br />
＃ちなみにタイトルは釣りだそうですｗ</p>
<blockquote><p>『プログラマが知るべき97のこと』（オライリー・ジャパン刊・オーム社発売）刊行記念トークセッション<br />
よいソフトウェアを作るプログラミングとは</p>
<p>森田創(寄稿者)×舘野祐一(寄稿者)×和田卓人(監修者)</p>
<p>■2011年1月15日(土)19:00?</p>
<p>新刊『プログラマが知るべき97のこと』（オライリー・ジャパン刊・オーム社発売）の刊行を記念して、本書監修者の和田卓人氏と寄稿者の森田創氏、舘野祐一氏の3名がプログラミングをテーマに語ります。<br />
よいソフトウェアを作るために必要なこととは何でしょうか。<br />
バージョン管理やテスト、自動化のツールとその知識、はたまたコーディング規約やスタイルでしょうか。<br />
それともプログラマのスキルアップの勉強法や、チームでのコミュニケーションでしょうか。<br />
自ら手がけるものの質を向上させるために、プログラミングを生業とする技術者ひとりひとりが「知るべきこと」を自らの体験を交えて大いに語り合います。
</p></blockquote>
<ul>
<li><a href="http://www.ustream.tv/recorded/12026561">USTREAM</a></li>
<li><a href="http://togetter.com/li/89570">Togetter</a></li>
</ul>
<p><a id="more"></a><a id="more-533"></a><br />
壁面にトークのアジェンダのマインドマップが書かれていたので、それをベースにマップを作成してみました。細かい表現などは自分フィルターがかかっていて、本来言っていたことと一致していない可能性あります。ので、詳しくはUST,Togetterを御覧ください。。。</p>
<div style="width:425px" id="__ss_6577665"><strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/restartr/ss-6577665" title="よいソフトウェアを作るプログラミングとは">よいソフトウェアを作るプログラミングとは</a></strong><object id="__sse6577665" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=random-110115085249-phpapp01&amp;stripped_title=ss-6577665&amp;userName=restartr" /><param name="allowFullScreen" value="true" /><param name="allowScriptAccess" value="always" /><embed name="__sse6577665" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=random-110115085249-phpapp01&amp;stripped_title=ss-6577665&amp;userName=restartr" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355" /></object>
<div style="padding:5px 0 12px">View more <a href="http://www.slideshare.net/">presentations</a> from <a href="http://www.slideshare.net/restartr">Re STARTR</a>.</div>
</div>
<p>トークの内容は、登壇者のプログラマになったきっかけからはじまり、どんな開発現場か、どのように技術を身につけてきたか、などを語り合うものでした。<br />
「９７のこと」についてはQ&amp;Aのときの質問がでるまで触れられなかったというｗ</p>
<h3>JavaScriptの特殊性</h3>
<p>面白かったのは、和田さんが「JavaScriptはプログラミングパラダイムの交差点」と言っていたこと。<br />
MochiKitはPythonの関数的なものを、prototype.jsはオブジェクト志向が取り入れられていたりと。たしかに、JSって言語のなかでもかなり特殊ですよね。Webサービスで言えば、サーバーサイドはいろんな言語が使われるけど、ブラウザ上では唯一のプログラミング言語（一応ASもあるけど）。だからこそ、他言語で馴染みのあるパラダイムを取り入れようとするんでしょう。</p>
<h3>プログラマの責務</h3>
<p>これまで感じた「うれしかったこと」に対して「信念を突き通して作ったものに対する喜びの反応をもらったとき」という回答がありましたが、こればかりは普遍ですね。スタンドアロンであれWebサービスであれ、作るものや使う技術は変われど、誰か使いたいと思ってくれる人に対して価値を提供することが我々プログラマの責務ですから。</p>
<p>登壇者の方々、貴重なおはなしをどうもありがとうございました。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/15/97things-every-programmers-should-know/">プログラマが知るべき97のこと</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-15T00:39:03+09:00" pubdate data-updated="true">2011-01-15 (Sat)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>「プログラマが知るべき97のこと」を読みました。</p>

<ul>
  <li><a href="http://www.amazon.co.jp/dp/4873114799">プログラマが知るべき97のこと</a></li>
</ul>

<p>一時期いろいろネタにもされていましたが、読んで損はない本ですね。
内容は、プログラマの精神論から設計のTipsやパターン紹介まで多岐にわたっています。が、ひとつひとつが見開き1ページにまとまっているため、あとで気軽に読み返せますので、ぜひデスクに常備しておきたい一冊となりました。</p>

<p><a id="more"></a><a id="more-518"></a></p>

<p>主に精神論のはなしに惹かれたので少しまとめを。</p>

<h3>問題のあるソフトウェアをつくりだす可能性と、それに対して立ち向かう姿勢</h3>
<p>どれだけ経験を重ねても、度重なる変更やスケジュールからの圧力などによって、品質が悪くなることは往々にしてあります。</p>

<p><strong>24.変更を恐れない     Mike Lewis</strong></p>

<blockquote>
作っている人間がシステムを嫌っているようでは、そんなものを遣わされる側はたまらないでしょう。

</blockquote>
<p>病気なソフトウェアを治すには痛みを伴うが、それを治すことで利益も得られ、治すことはメンバーにとって経験となると言っています。積極的にシステムを改良していくという姿勢はチームに伝播しやすいものであると。</p>

<p><strong>52.「その場しのぎ」が長生きしてしまう     Klaus Marquardt</strong></p>

<blockquote>
いったん「暫定ソリューション」ができてしまうと、既成事実化するのです。

</blockquote>
<p>さらに、暫定ソリューションに対する修正も暫定になってしまいがち。でも、「ソリューション」というだけに必要なものではあるはず。修正の優先度があがる体制づくりをするとか、もっと有用なソリューションを開発すればよい、と言っています。
いつまでたっても暫定のままの暫定ソリューションはいくつも見てきたので、かなり実感湧きます。</p>

<h3>新しいことを学び続ける姿勢</h3>
<p>新しい言語を毎年学ぶと良いというのは、割とよく聞く話しだと思います。</p>

<p><strong>26.言語だけでなく文化も学ぶ     Anders Noras</strong></p>

<blockquote>
そうではなく、新しい言語から新たな発想を得て、同じ問題に対して違った解決策を見つけられるようになることが大事なのです。

</blockquote>
<p>ある言語では言語仕様で対応してくれているけどその他の言語では自分で実装しなければいけなかったり（GCとか）、そういった、各言語ごとの視点を自分に取り入れるのは良いことです。
私は、ふだんPHPでオブジェクト指向プログラミングをやっていて、Scalaという関数言語を学んでいます。Scalaを学ぶことで、なんとなく関数型思考でPHPコードを書いていることもあります。あきらかにその書いたコードにたいする距離感が違っていて、そのコードの根拠が明確になっている気がするのです。</p>

<h3>誰のためのコードか、という意識</h3>
<p>なぜかこのような似通ったテーマをとりあげた人が多くいました。</p>

<p><strong>35.超人の神話     Ryan Brush</strong></p>
<blockquote>
超人は必要ありません。必要なのはエキスパートです。積極的に自分以外にもエキスパートを育てようとする意思をもったエキスパートです。そういう人がいてくれれば、凡人が力をつけ、活躍できる可能性が生まれるでしょう。
</blockquote>
<p><strong>56.未来へのメッセージ     Linda Rising</strong></p>
<blockquote>
「自分の書くコードは、全部、未来の誰かへのメッセージだと思うのよ。その誰かは、あなたの弟さんかもしれない。誰か、とても賢い人に、自分が難しい問題をどう解いたのか、丁寧に説明するつもりで書くの。」
</blockquote>
<p><strong>82.他社への思いやりを意識したコーディング     Aslam Khan</strong></p>
<blockquote>
他人の存在を意識すれば、他人の書くコードにも当然良い影響を与えることになります。チームの同様のことを考え、思いやりを持ってコードを書けば、それは同僚たちにとって価値あるコードとなり、いずれ自分にも良い影響となって帰ってきます。どんなかたちであれ、そのコードに触れた誰もが、触れる前より良い人間、良いプログラマになれる、そういうコードを書くようにすべきでしょう。

</blockquote>
<p><strong>88.コードは生涯サポートするつもりで書く     Yuriy Zubarev</strong></p>
<blockquote>
「生涯サポートしなくてはならない」と考えながら仕事をするようになれば、素晴らしいことが起きるでしょう。
</blockquote>
<p>チームで開発するのが当然な現場では当たり前のことですが意外と意識できていなかったりします。私も、新しく知り得たパターンとかついつい自分の判断で取り入れてしまい、誰が見てもわかりにくいコードを書いたこともあります。今でもそういうコードになっているかもしれません。</p>

<p>こういうことを無意識にできるように、ペアプログラミングをするのも効果的かもしれません。隣で同じ画面を見ている「他人の目」が常にあり、自分も他人も納得のいく設計が結果的にできるわけですから。</p>

<p>と、ここまで書かれた複数人の内容をひとりじめするような内容の人がいましたw</p>

<p><strong>91.良いプログラマになるには     Pete Goodliffe</strong></p>
<blockquote />
<p>‘とりあえず’という意識を捨て、他人や未来の自分のためにわかりやすいコードを書き、新しいことを学び続けよう、ということを彼は言っています。
※前述のテーマについては、それぞれにエピソードが違うので、どれを読んでも面白いものなので、まとめのようなものがあっても別に構わないのですが。</p>

<p>目の前のコードに集中しがちですが、冷静になって、こういった基本姿勢を思い返すようにしたいものです。</p>

<p>「達人プログラマー」や、「リファクタリング」など、引用された本で未読のものがいくつかあったので、これらについても今後読んでみようと思います。</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2011/01/10/6-targets-i-want-to-achieve-in-2011/">2011年に達成したい6つの目標</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-01-10T21:28:27+09:00" pubdate data-updated="true">2011-01-10 (Mon)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>新年開けて少し経ってしまいましたが、ここで2011年の目標を立てたいと思います。<br />
去年は10個挙げましたが、どうせ途中で気が変わると思うので、最低限やっておきたいこと5つに絞りました。<br />
本業はPHPなので、PHP5.3やSymfony2なんかも学習しなければいけないのですが、ここでは本業でなかなか携われないところを中心にセレクトしました。</p>
<ol>
<li>英会話能力の強化</li>
<li>Scalaの学習を継続</li>
<li>pythonに手を出す</li>
<li>MySQL5.5を使いこなす</li>
<li>アジャイル開発に詳しくなる</li>
<li>読書感想文をブログに書く</li>
</ol>
<p>ひとつひとつ補足しておきます。<br />
<a id="more"></a><a id="more-508"></a></p>
<h4>1.英語力の強化</h4>
<p>TOEIC600点程度を目指したい。試験は受けるかは別にして、特に技術書をスムーズに読める程度にはなっておきたい。でもどちらかといえば英会話に重きを置きたいところ。</p>
<h4>2.Scalaの学習を継続</h4>
<p>2010年8月からScalaをやり出したので、まだまだ初心者の域を抜け出せていません。GAEのWebアプリ開発や、並行プログラミングにもっと詳しくなりたい。</p>
<h4>3.pythonに手を出す</h4>
<p>何やら、pythonは統計解析やWebプログラミングなど、どの領域にも必須な雰囲気をひしひしと感じているので、いい加減ちゃんと学習します。<br />
難解なワンライナーはかけなくても良いですが、最低限のお作法は押さえていこうと思います。NLP本とGAEアプリ開発を通じての学習になるかと。</p>
<h4>4.MySQL5.5を使いこなす</h4>
<p>2010年はNoSQLが流行りましたが、正直そこまで必要性を感じていないというが現状。なのでMySQLの知らないところや可能性を掘り下げて行きたい。<br />
年末には本気アップデートのMySQL5.5 GAが出たので、性能検証しつつMySQLをもっと好きになるべく戯れます。</p>
<h4>5.アジャイル開発に詳しくなる</h4>
<p>具体的にはTDDとCI(BTS,VCS等の連携)を中心にやりたいです。これに関してはただ学ぶだけではなく、積極的に実践投入していきたいところ。<br />
もういい加減に負のスパイラルから抜け出さないと。</p>
<h4>6.読書感想文を書く</h4>
<p>去年もけっこう本は読みましたが、読んで終わりがほとんど。もったいないので、まとめをブログに書いていこうと思います。あとで見返すためにも。</p>
<p>昨年は、様々な勉強会に顔をだし、講演を聴いたりコミュニケーションしたり、たくさんの方にお世話になりました。勉強会に出ることが、いかにモチベーション維持に寄与するかというのを実感できた良い年になりました。今年もちょくちょく顔を出したいと思いますので、その際はひとつお手柔らかにお願いいたします。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/12/31/10-targets-that-i-wanted-to-achieve-in-2010/">2010年に達成したかった10の目標</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-31T14:33:20+09:00" pubdate data-updated="true">2010-12-31 (Fri)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>さて、今年もあと二日になりましたので、2010年年明けに掲げた「達成したい10の目標」について振り返ってみます。</p>
<p><a id="more"></a><a id="more-500"></a></p>
<h4>禁煙を継続する</h4>
<p>禁煙続いています。実は二本ほどもらいタバコしましたが、その場のノリなのでとくに問題なし。</p>
<h4>間食は一日一回</h4>
<p>会社ではできているけど、家ではできていないかも。ついついおやつを買い込んでしまうもので。</p>
<h4>ヤフオクは一ヶ月に一回まで</h4>
<p>落札については月一回もやっていないのでOK。</p>
<h4>春までにいらないものを積極的に(捨てて|売って)身軽になる</h4>
<p>結構売りさばいたので今は少しモノは減ったと思います。今後もさらに整理していきます。</p>
<h4>身軽になったところで家を引っ越す</h4>
<p>春までに、という目標でしたが結局2月に引越し完了。思い立ったら行動せずにはいられないようで。</p>
<h4>ブログを一週間に一回は更新する</h4>
<p>はい、無理でした。<br />
だいたいがTwitterで足りるし、ソースコードとかまとめて残したいときにブログ使うくらい。</p>
<h4>何かひとつオリジナルのwebサービスを公開する</h4>
<p>サービスのリリースはできませんでした。（途中で頓挫したプロジェクトもありました。）<br />
サービスではないですが、PHPMATSURIでDebugKitプラグインを公開したのは、この目標に近いかも。</p>
<h4>PHP以外の言語にも積極的に取り組む(c++/java/python/erlang?)</h4>
<p>Scalaを選択しました。関数型言語として一番実用的に感じたからです。<br />
実際仕事で使ってはいませんが、関数型言語を学ぶことで得られたものはPHPでのプログラミングにも取り入れられているきがします。気づきを得るという意味でも成功かと。Scalaは今後も引き続き弄っていきたい言語になりました。</p>
<h4>自然言語処理に詳しくなる</h4>
<p>そこまで進まず…もう少し基礎的なところを固めつつという方向に向かいました。オライリーのNLP本は入手しているので、2011年に読み進めようと思います。</p>
<h4>英語と数学をちゃんと勉強し直す</h4>
<p>それぞれ本は買ったけど、、、、ほぼ読んでないです。英語は、PCの言語設定を変えたり、英書を読んだりしてできるだけ英語に触れる機会を増やしています。<br />
英会話については今後の課題。</p>
<p>生活面については、ジョギングをはじめたりして、それまでより改善できているように思います。が、プログラマとしての達成度で言えばまだまだです。来年はインプットよりアウトプットを重視した一年にしたいと思います。</p>
<p>2010年、仕事で関わった皆様、勉強会で出会った皆様、私と関わりのあった皆様に感謝します。そして、来年もどうぞよろしくお願いいたします。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/12/29/websocket-server-written-in-scala-with-netty/">NettyでWebSocketサーバーを実装する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-29T18:45:53+09:00" pubdate data-updated="true">2010-12-29 (Wed)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>この記事は <a href="http://atnd.org/events/10683">Scala Advent Calendar JP 2010</a> 23 日目(12/29)です。</p>
<p>前日の <a href="http://twitter.com/cooldaemon">@cooldaemon</a> さんが<a href="http://d.hatena.ne.jp/cooldaemon/20101228">Scala Actor + NIO</a>という、ものすごい記事を書いていらっしゃったのでこの流れの中で投稿するのが忍びないくらいです。<br />
＃まさか前日にNIOネタがくるとはぁぁぁ…</p>
<p>さて、今回はNettyを使ってWebSocketサーバーを実装してみました。<br />
JavaではなくScalaで、です。<br />
とはいっても、目的はJavaコードをScalaに直す練習も兼ねて、公式サンプルにあるJavaコードをScalaに書きなおしただけですが。<br />
ご指摘などありましたら謹んでお受けいたします…<br />
<a id="more"></a><a id="more-465"></a></p>
<h3>Netty</h3>
<ul>
<li><a href="http://www.jboss.org/netty/">Netty - the Java NIO Client Server Socket Framework - JBoss Community</a></li>
</ul>
<p>Nettyの概要はこのへんで。</p>
<ul>
<li><a href="http://ameblo.jp/principia-ca/entry-10629939611.html">JavaネットワークアプリケーションフレームワークNettyの紹介｜サイバーエージェント 公式エンジニアブログ</a></li>
</ul>
<h3>開発環境</h3>
<ul>
<li>Scala-2.8.0</li>
<li>Netty-3.2.3.Final</li>
</ul>
<h3>Echoサーバー</h3>
<p>サンプル的にEchoサーバーから書いてみます。</p>
<h4>やること</h4>
<ol>
<li>Echoハンドラを実装</li>
<li>NioChannelFactoryにスレッドプールを登録</li>
<li>BootstrapにNioChannelFactoryを登録</li>
<li>PipelineFactoryにEchoハンドラを登録</li>
<li>BootstrapにPipelineFactoryを登録</li>
<li>InetSocketAddressに（ホストと）ポート番号を指定してBootstrapに登録してサービス開始</li>
</ol>
<p><a href="https://github.com/ReSTARTR/nettyws/blob/master/src/main/scala/com/restartr/nettyws/EchoServer.scala">EchoServer.scala</a><br />
まずは起動元から。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">EchoServer</span> <span class="o">{</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// サーバーのセットアップ</span>
</span><span class="line">    <span class="k">val</span> <span class="n">bootstrap</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">(</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">NioServerSocketChannelFactory</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Executors</span><span class="o">.</span><span class="n">newCachedThreadPool</span><span class="o">(),</span> <span class="c1">// bossExecutor</span>
</span><span class="line">        <span class="nc">Executors</span><span class="o">.</span><span class="n">newCachedThreadPool</span><span class="o">()</span>  <span class="c1">// workerExecutor</span>
</span><span class="line">      <span class="o">))</span>
</span><span class="line">
</span><span class="line">    <span class="n">bootstrap</span><span class="o">.</span><span class="n">setPipelineFactory</span><span class="o">(</span>
</span><span class="line">      <span class="c1">// リクエストをそのまま返すハンドラを実装して登録</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">ChannelPipelineFactory</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">def</span> <span class="n">getPipeline</span><span class="o">()</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">(</span><span class="k">new</span> <span class="nc">EchoServerHandler</span><span class="o">())</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 8080番で待ち受け開始</span>
</span><span class="line">    <span class="n">bootstrap</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>で、ハンドラ側がこんなかんじ。<br />

SimpleChannelUpstreamHandlerの</p>
<ul>
<li>messageReceived(ctx:ChannelHandlerContext, e:MessageEvent)</li>
<li>def exceptionCaught(ctx: ChannelHandlerContext, e: ExceptionEvent) </li>
</ul>
<p>をオーバーライドして処理内容を定義すればOK。<br />
何かを呼び出し元に返すには、&#8221;e.getChannel().write( {レスポンス} )&#8221;で。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">EchoServerHandler</span> <span class="k">extends</span> <span class="nc">SimpleChannelUpstreamHandler</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">logger</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="s">&quot;EchoServerHandler&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">transferredBytes</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// そのまま返す</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">messageReceived</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span><span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span><span class="kt">MessageEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transferredBytes</span><span class="o">.</span><span class="n">addAndGet</span><span class="o">(</span>
</span><span class="line">      <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">().</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">ChannelBuffer</span><span class="o">].</span><span class="n">readableBytes</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;echo_server: message received: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">())</span>
</span><span class="line">    <span class="c1">// レスポンスを返す</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">())</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// 例外発生時はここにくる</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">exceptionCaught</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">ExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="nc">WARNING</span><span class="o">,</span>
</span><span class="line">               <span class="s">&quot;Unexpected exception from downstream.&quot;</span><span class="o">,</span>
</span><span class="line">               <span class="n">e</span><span class="o">.</span><span class="n">getCause</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>WebSocketサーバー</h3>
<p>本題のWebSocketサーバーです。<br />
Echoサーバーの応用で、WebSocket用のハンドラを作成して、Bootstrapに登録すれば良い訳です。</p>
<h4>仕様</h4>
<ul>
<li>WebSocketServer: 起動元</li>
<li>WebSocketServerHandler: プロトコルハンドラ。肝の部分。</li>
<li>WebSocketServerPipelineFactory: パイプライン生成。</li>
<li>WebSocketServeIndexPage: WebSocketクライアント用HTMLの生成</li>
</ul>
<h4>実装</h4>
<p>すべて書くと冗長なので要所だけ抜き出しました。<br />
<a href="https://github.com/ReSTARTR/nettyws/tree/master/src/main/scala/com/restartr/nettyws">全ソースはGithubを見てください。</a></p>
<p><b>WebSocketServerIndexPage.scala</b><br />
まずはクライアント側はこんな感じで、インプットフォームに入力した文字列をWebSocketサーバーに投げ、結果をdivに追記するだけです。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line">  <span class="k">var</span> <span class="n">socket</span><span class="o">;</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">window</span><span class="o">.</span><span class="nc">WebSocket</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">socket</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WebSocket</span><span class="o">(</span> <span class="-Symbol">&#39;ws</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">8080</span><span class="kt">/uppercase</span><span class="err">&#39;</span> <span class="o">);</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onmessage</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onopen</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="-Symbol">&#39;web</span> <span class="n">socket</span> <span class="n">opened</span><span class="err">&#39;</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onclose</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="-Symbol">&#39;web</span> <span class="n">socket</span> <span class="n">closed</span><span class="err">&#39;</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">alert</span><span class="o">(</span><span class="-Symbol">&#39;your</span> <span class="n">browser</span> <span class="n">does</span> <span class="n">not</span> <span class="n">supported</span> <span class="n">web</span> <span class="n">socket</span><span class="err">&#39;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">function</span> <span class="n">log</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">p</span> <span class="k">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="o">(</span><span class="-Symbol">&#39;p</span><span class="err">&#39;</span><span class="o">);</span>
</span><span class="line">    <span class="n">p</span><span class="o">.</span><span class="n">innerHTML</span> <span class="k">=</span> <span class="n">message</span>
</span><span class="line">    <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="o">(</span><span class="-Symbol">&#39;log</span><span class="err">&#39;</span><span class="o">).</span><span class="n">appendChild</span><span class="o">(</span><span class="n">p</span><span class="o">)</span> <span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">function</span> <span class="n">send</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">window</span><span class="o">.</span><span class="nc">WebSocket</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span><span class="o">;</span> <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="n">readyState</span> <span class="o">==</span> <span class="nc">WebSocket</span><span class="o">.</span><span class="nc">OPEN</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">alert</span><span class="o">(</span><span class="-Symbol">&#39;the</span> <span class="n">socket</span> <span class="n">is</span> <span class="n">not</span> <span class="n">open</span><span class="o">.</span><span class="err">&#39;</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServer.scala</b><br />
サーバー起動オブジェクトです。<br />
HTML/WebSocketを扱うハンドラを登録してポートで待ち受けます。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// WebSocket用ハンドラを含むPipelineFactoryを登録</span>
</span><span class="line"><span class="n">bootstrap</span><span class="o">.</span><span class="n">setPipelineFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebSocketServerPipelineFactory</span><span class="o">())</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 8080番で待ち受け開始</span>
</span><span class="line"><span class="n">bootstrap</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">8080</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServerHandler.scala</b><br />
実装するのは、Echoサーバーと同じく、messageReceived()とexceptionCaught()の２つ。<br />
処理を分割しているのですこしだけメソッド多めです。<br />
messageRecieved()で受信内容によって実際のハンドラをHttp/WebSocketのどちらかに切り替えます。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">WebSocketServerHandler</span> <span class="k">extends</span> <span class="nc">SimpleChannelUpstreamHandler</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">WEBSOCKET_PATH</span> <span class="k">=</span> <span class="s">&quot;/uppercase&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * メッセージ受信時の処理</span>
</span><span class="line"><span class="cm">   *   メッセージの内容によってWebSocketかHttpかハンドラを切り替える</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">messageReceived</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MessageEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">msg</span><span class="k">:</span><span class="kt">Object</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">()</span>
</span><span class="line">    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">frame</span><span class="k">:</span> <span class="kt">WebSocketFrame</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">handleWebSocketFrame</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">frame</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="k">case</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">handleHttpRequest</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">req</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * HTTPリクエスト時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">handleHttpRequest</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// DEBUG</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;handleHttpRequest: &quot;</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="n">currentThread</span><span class="o">().</span><span class="n">getName</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// GETリクエスト以外は処理しない</span>
</span><span class="line">    <span class="c1">// &quot;/&quot;にきたらWebSocketクライアント用ページを送信</span>
</span><span class="line">    <span class="c1">// &quot;/uppercase&quot;にきたらリクエスト文字列を大文字に変換して返す</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getMethod</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">GET</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">sendHttpResponse</span><span class="o">(</span>
</span><span class="line">        <span class="n">ctx</span><span class="o">,</span>
</span><span class="line">        <span class="n">req</span><span class="o">,</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">DefaultHttpResponse</span><span class="o">(</span><span class="nc">HTTP_1_1</span><span class="o">,</span> <span class="nc">FORBIDDEN</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getUri</span><span class="o">().</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">    	
</span><span class="line">      <span class="c1">// (中略) デフォルトHTMLの送信</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getUri</span><span class="o">().</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="nc">WEBSOCKET_PATH</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">               <span class="nc">Values</span><span class="o">.</span><span class="nc">UPGRADE</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">Names</span><span class="o">.</span><span class="nc">CONNECTION</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
</span><span class="line">               <span class="nc">Values</span><span class="o">.</span><span class="nc">WEBSOCKET</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">Names</span><span class="o">.</span><span class="nc">UPGRADE</span><span class="o">)))</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// (中略) WebSocket接続処理</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// ハンドラをHTTPからWebSocketに切り替えて、</span>
</span><span class="line">      <span class="c1">// send the handshake response</span>
</span><span class="line">      <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">getPipeline</span><span class="o">()</span>
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="s">&quot;aggregator&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;decoder&quot;</span><span class="o">,</span> <span class="s">&quot;wsdecoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketFrameDecoder</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">      <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">res</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;encoder&quot;</span><span class="o">,</span> <span class="s">&quot;wsencoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketFrameEncoder</span><span class="o">())</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">sendHttpResponse</span><span class="o">(</span>
</span><span class="line">        <span class="n">ctx</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DefaultHttpResponse</span><span class="o">(</span><span class="nc">HTTP_1_1</span><span class="o">,</span> <span class="nc">FORBIDDEN</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * WebSocketリクエスト時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">handleWebSocketFrame</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">frame</span><span class="k">:</span> <span class="kt">WebSocketFrame</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// 大文字に変換するして、WebSocketFrameにのせてレスポンスを返す。</span>
</span><span class="line">    <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">DefaultWebSocketFrame</span><span class="o">(</span>
</span><span class="line">        <span class="n">frame</span><span class="o">.</span><span class="n">getTextData</span><span class="o">().</span><span class="n">toUpperCase</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * HTTPレスポンスの送信</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">sendHttpResponse</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">,</span> <span class="n">res</span><span class="k">:</span> <span class="kt">HttpResponse</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// ステータスコードが200じゃなければエラーページの表示</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">getCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">res</span><span class="o">.</span><span class="n">setContent</span><span class="o">(</span>
</span><span class="line">        <span class="nc">ChannelBuffers</span><span class="o">.</span><span class="n">copiedBuffer</span><span class="o">(</span>
</span><span class="line">          <span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">toString</span><span class="o">(),</span> <span class="nc">CharsetUtil</span><span class="o">.</span><span class="nc">UTF_8</span><span class="o">))</span>
</span><span class="line">      <span class="nc">HttpHeaders</span><span class="o">.</span><span class="n">setContentLength</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">res</span><span class="o">.</span><span class="n">getContent</span><span class="o">().</span><span class="n">readableBytes</span><span class="o">())</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// keep-aliveでなければ接続を閉じる</span>
</span><span class="line">    <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">res</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="n">isKeepAlive</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="o">||</span> <span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">getCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">f</span><span class="o">.</span><span class="n">addListener</span><span class="o">(</span><span class="nc">ChannelFutureListener</span><span class="o">.</span><span class="nc">CLOSE</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * 例外発生時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">exceptionCaught</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">ExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;server: exception caught: &quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getCause</span><span class="o">().</span><span class="n">printStackTrace</span><span class="o">()</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * WebSocket接続情報</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">def</span> <span class="n">getWebSocketLocation</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">    <span class="s">&quot;ws://&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="nc">Names</span><span class="o">.</span><span class="nc">HOST</span><span class="o">)</span> <span class="o">+</span> <span class="nc">WEBSOCKET_PATH</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServerPipelineFactory.scala</b><br />
パイプラインへの登録を定義します。<br />
リクエストはDecoderを通り、ハンドラで処理され、Encoderを通って返される、という流れです。<br />
ここでは初期状態としてHttp用の設定になっていますが、一旦WebSocket通信開始のリクエストを受け取ると、そのあとはWebSocketのDecoder/Encoderに切り替わります。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="o">&lt;</span><span class="n">pre</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;brush:scala&quot;</span><span class="o">&gt;</span>
</span><span class="line"><span class="k">class</span> <span class="nc">WebSocketServerPipelineFactory</span> <span class="k">extends</span> <span class="nc">ChannelPipelineFactory</span><span class="o">{</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">getPipeline</span><span class="o">()</span><span class="k">:</span> <span class="kt">ChannelPipeline</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;decoder&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpRequestDecoder</span><span class="o">())</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;aggregator&quot;</span> <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpChunkAggregator</span><span class="o">(</span><span class="mi">65536</span><span class="o">))</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;encoder&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpResponseEncoder</span><span class="o">())</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;handler&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketServerHandler</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">pipeline</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>実際、ブラウザでひらいてみると、Webフォームに入力されている「hello, world」が大文字に変換されてフォーム下部に追記されていきます。<br />
まぁWebSocketサーバーを実装するだけなら、jetty7を使ったほうがシンプルに早くかけると思います。<br />
Memcacheプロトコルを話すサービスをつくる場合とかには便利ですね。（messagepack-rpcでもnetty使っているとか。)</p>

<p>参考：</p>

<ul>
  <li><a href="http://gihyo.jp/dev/feature/01/websocket">Jettyで始めるWebSocket超入門</a></li>
  <li><a href="http://d.hatena.ne.jp/yuroyoro/20100316/1268735022">Jetty7のWebSocketをScalaから使う - ゆろよろ日記</a></li>
</ul>

<p>以上、お粗末様でした。。。</p>
<p># あれ？Scalaあんまり関係ない？？</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/11/23/scala-erlang-php-and-me/">ScalaとErlangとPHPと私</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-23T18:57:35+09:00" pubdate data-updated="true">2010-11-23 (Tue)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>PHPよりScalaが簡単である、という議論に対するふたつのポストがあったので、自分向けにまとめました。</p>
<ul>
<li>元記事：<a href="http://wadearnold.com/blog/scala/scala-is-easier-than-php">Wade Arnold ? Scala is easier than PHP</a></li>
<li>返信：<a href="http://videlalvaro.github.com/2010/11/reply-to-scala-is-easier-than-php.html">Reply to &#8220;Scala is Easier than PHP&#8221;</a></li>
</ul>
<h3>概要</h3>
<p>ざっとこんな感じにまとめてしまいました。</p>
<ul>
<li>議論の中心はWebページ生成言語としての言語の比較ではない</li>
<li>ふたりともWebページ生成ならPHPが優れているという立場にかわりはない</li>
<li>議論の中心は主にスケーラビリティの確保とプロセス間通信</li>
<li>元記事のWade ArnoldさんはScala推進派</li>
<li>返信者のvidelalvaroさんはErlang推進派</li>
<li>スケーラビリティ確保のためには関数型言語という結論</li>
<li>ScalaかErlangどちらが簡単か、という議論はない</li>
</ul>
<p><a id="more"></a><a id="more-410"></a></p>
<h3>ScalaがPHPより簡単な理由</h3>
<p>Wade Arnoldさんが元記事「Scala is easier than PHP」において、マルチコア時代にはScalaが必要だ、みたいなことを書きました。彼はPHP３のころからPHPの開発に関わっていて、最近はZendFrameworkのコミッタをやっていたそうです。<br />
PHPはいまだに最高の言語であると最初に断っておきつつ、Scalaの技術的な点を整理しておこう、という内容。</p>
<p>スケーラビリティの確保のためには、PHPのようにたくさんのツールを必要とせずとも、言語仕様的に多くをサポートするScalaが簡単な理由である、と。Scalaへの移行は時間を必要とするが、スケーラビリティには必要な選択であるといっています。</p>
<blockquote><p>No need for amqp with actors, no beanstalkd with mutable queues, and it’s fast as hell!</p></blockquote>
<p><em>ActorによってAMQPはいらなくなる。ミュータブルなキューもbeanstalkdなしに。そしてそれはものすごく速い。<br />
</em></p>
<h3>PHPの代わりにErlangを使う理由</h3>
<p>それに対してvidelalvaroさんが「Reply to &#8220;Scala is easier than PHP&#8221;」でコメントをしています。<br />
おおむねWadeさんの意見に同意で、彼はScalaではなくErlangを推しているようです。</p>
<p>意見としてはこんな感じでしょうか。</p>
<ul>
<li>サーバーのような長時間実行するプログラムにはErlangつかうといい</li>
<li>スレッド間通信にはErlangをつかうといい</li>
<li>Webページを生成するだけならPHPをつかうといい</li>
<li>CPUの全コアを利用したいだけならPHP-FPMをつかうといい</li>
</ul>
<h3>スケーラビリティ確保のために必要なもの</h3>
<p>元記事ではPHPのスケーラビリティ確保のために必要なものをあげ、これらを使うのは大変骨が折れると言っています。</p>
<blockquote>
<ul>
<li>Fantastic at PHP internals</li>
<li>Amazing at Apache HTTPD and compiling appropriate PHP extensions.</li>
<li>Nginx</li>
<li>BigIP ? More than round robin load balancing</li>
<li>Intimately know how sessions work and probably write your own handlers</li>
<li>Memcached</li>
<li>APC</li>
<li>AMQP</li>
<li>BeanStalkd</li>
<li>Code based sharding or at least master/slave logic</li>
<li>C/C++</li>
<li>Lots of security! It’s a problem with all dynamic languages.</li>
<li>Zend Framework.</li>
</ul>
</blockquote>
<p>それに対してScalaはたった５つ。</p>
<blockquote>
<ul>
<li>6 months of scala</li>
<li>Functional programming</li>
<li><a onclick="javascript:_gaq.push(['_trackEvent','outbound-article','akkasource.org']);" href="http://akkasource.org/">Akka Framework</a></li>
<li><a onclick="javascript:_gaq.push(['_trackEvent','outbound-article','liftweb.net']);" href="http://liftweb.net/">Lift Framework</a></li>
<li>Nginx / Jetty</li>
</ul>
</blockquote>
<p>ツールに頼らずとも言語が機能を備えているから気にすべきところが非常にシンプルになるようです。</p>
<h3>個人的感想</h3>
<p>PHPをWebページ生成以外で対決させるのはどうなんだろうと思いつつも、Scalaをどのような場面で使っていけばよいか考える良い機会になりました。<br />
個人的な話をすると、Scalaは言語仕様を学ぶばかりで実際のプログラムを書くまでには至っていませんし、性能評価もまだやってないので「PHPからScalaに移行すべきだ」、と言い切るには至っていないのが現状です。<br />
が、Wadeさんは後ほどもっと突っ込んだ記事を書くと冒頭に言っていますし、videlalvaroさんも最後に</p>
<blockquote><p>if we want to sell functional languages like Erlang or Scala to the PHP programmer then we have to look for more compelling features that may attract them to look into these languages. What I think are those features ?I guess?, should be part of another blog post.</p></blockquote>
<p>と、ScalaやErlangをPHPerに売り込むための魅力的な点をPOSTしてくれるかも。<br />
それも楽しみにしておこうと思います。</p>
<h3>余談</h3>
<p>最近思うのが、Scalaって言語仕様があまりに多くて、それを学ぶことが楽しいです。<br />
が、学ぶべき仕様がどこまでなのか見えてこず、さらに、仕様を学ぶこと自体が目的になってきているような気がします。<br />
ということで(?)そろそろ、実際につくりたいプログラムを書きながら仕様を学ぶ方向にシフトしようと思います。</p>
<p>※あとPHP-FPMもちゃんと調査・検証したいし、Kestrelのソースも読みたい。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives/"> Archives </a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section id="titles">
  <a href="http://blog.restartr.com" title="I Will Servive"><img id="logo" src="http://blog.restartr.com/images/portrait.jpg" /></a>
  <h1 id="site_title"><a href="http://blog.restartr.com" title="I Will Servive">I Will Servive</a></h1>
  <h3 id="site_subtitle">An application depelopper&#8217;s blog.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://blog.restartr.com"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://blog.restartr.com/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://blog.restartr.com/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://blog.restartr.com/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  
    <a href="" title="g+#103216164658230535238"><i class="fa fa-google-plus fa-2x"></i></a>
  

  
    <a href="https://github.com/ReSTARTR" title="ReSTARTR"><i class="fa fa-github fa-2x"></i></a>
  

  

  
    <a href="https://twitter.com/ReSTARTR" title="ReSTARTR"><i class="fa fa-twitter fa-2x"></i></a>
  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/04/06/move-from-wordpress-to-octopress/">WordpressからOctpressに移行</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/26/connect-go-and-python-with-zeromq/">GoとPythonをZeroMQで繋ぐ</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/17/bind-a-variable-to-closure-in-python/">pythonのクロージャに変数を束縛する方法</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/05/my-first-pytest/">pythonのテストにpytestを使ってみた</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/02/retirement201303/">Kauli株式会社を退職しました</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ReSTARTR">@ReSTARTR</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ReSTARTR',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103216164658230535238?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - ReSTARTR -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ReSTARTR';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>


<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>I Will Survive</title>
  <meta name="author" content="ReSTARTR">
  <link rel="author" href="https://plus.google.com/103216164658230535238" />
  <meta name="google-site-verification" content="NrAeSKEW2-UUxTVliLJ7-38Af1sR4lDMPeEnZwjVc6o" />

  
  <meta name="description" content="この記事は Scala Advent Calendar JP 2010 23 日目(12/29)です。
前日の @cooldaemon さんがScala Actor + NIOという、ものすごい記事を書いていらっしゃったのでこの流れの中で投稿するのが忍びないくらいです。
＃ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.restartr.com/page/25/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="I Will Survive" type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>


	<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$$','$$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>




  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-894530-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <meta name="google-site-verification" content="NrAeSKEW2-UUxTVliLJ7-38Af1sR4lDMPeEnZwjVc6o" />
  <style>html{background: url("/images/background.png") no-repeat center center fixed;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.restartr.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/12/29/websocket-server-written-in-scala-with-netty/">NettyでWebSocketサーバーを実装する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-29T18:45:53+09:00" pubdate data-updated="true">2010-12-29 (Wed)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>この記事は <a href="http://atnd.org/events/10683">Scala Advent Calendar JP 2010</a> 23 日目(12/29)です。</p>
<p>前日の <a href="http://twitter.com/cooldaemon">@cooldaemon</a> さんが<a href="http://d.hatena.ne.jp/cooldaemon/20101228">Scala Actor + NIO</a>という、ものすごい記事を書いていらっしゃったのでこの流れの中で投稿するのが忍びないくらいです。<br />
＃まさか前日にNIOネタがくるとはぁぁぁ…</p>
<p>さて、今回はNettyを使ってWebSocketサーバーを実装してみました。<br />
JavaではなくScalaで、です。<br />
とはいっても、目的はJavaコードをScalaに直す練習も兼ねて、公式サンプルにあるJavaコードをScalaに書きなおしただけですが。<br />
ご指摘などありましたら謹んでお受けいたします…<br />
<a id="more"></a><a id="more-465"></a></p>
<h3>Netty</h3>
<ul>
<li><a href="http://www.jboss.org/netty/">Netty - the Java NIO Client Server Socket Framework - JBoss Community</a></li>
</ul>
<p>Nettyの概要はこのへんで。</p>
<ul>
<li><a href="http://ameblo.jp/principia-ca/entry-10629939611.html">JavaネットワークアプリケーションフレームワークNettyの紹介｜サイバーエージェント 公式エンジニアブログ</a></li>
</ul>
<h3>開発環境</h3>
<ul>
<li>Scala-2.8.0</li>
<li>Netty-3.2.3.Final</li>
</ul>
<h3>Echoサーバー</h3>
<p>サンプル的にEchoサーバーから書いてみます。</p>
<h4>やること</h4>
<ol>
<li>Echoハンドラを実装</li>
<li>NioChannelFactoryにスレッドプールを登録</li>
<li>BootstrapにNioChannelFactoryを登録</li>
<li>PipelineFactoryにEchoハンドラを登録</li>
<li>BootstrapにPipelineFactoryを登録</li>
<li>InetSocketAddressに（ホストと）ポート番号を指定してBootstrapに登録してサービス開始</li>
</ol>
<p><a href="https://github.com/ReSTARTR/nettyws/blob/master/src/main/scala/com/restartr/nettyws/EchoServer.scala">EchoServer.scala</a><br />
まずは起動元から。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">object</span> <span class="nc">EchoServer</span> <span class="o">{</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span><span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// サーバーのセットアップ</span>
</span><span class="line">    <span class="k">val</span> <span class="n">bootstrap</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">(</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">NioServerSocketChannelFactory</span><span class="o">(</span>
</span><span class="line">        <span class="nc">Executors</span><span class="o">.</span><span class="n">newCachedThreadPool</span><span class="o">(),</span> <span class="c1">// bossExecutor</span>
</span><span class="line">        <span class="nc">Executors</span><span class="o">.</span><span class="n">newCachedThreadPool</span><span class="o">()</span>  <span class="c1">// workerExecutor</span>
</span><span class="line">      <span class="o">))</span>
</span><span class="line">
</span><span class="line">    <span class="n">bootstrap</span><span class="o">.</span><span class="n">setPipelineFactory</span><span class="o">(</span>
</span><span class="line">      <span class="c1">// リクエストをそのまま返すハンドラを実装して登録</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">ChannelPipelineFactory</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">def</span> <span class="n">getPipeline</span><span class="o">()</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">(</span><span class="k">new</span> <span class="nc">EchoServerHandler</span><span class="o">())</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// 8080番で待ち受け開始</span>
</span><span class="line">    <span class="n">bootstrap</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">8080</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>で、ハンドラ側がこんなかんじ。<br />

SimpleChannelUpstreamHandlerの</p>
<ul>
<li>messageReceived(ctx:ChannelHandlerContext, e:MessageEvent)</li>
<li>def exceptionCaught(ctx: ChannelHandlerContext, e: ExceptionEvent) </li>
</ul>
<p>をオーバーライドして処理内容を定義すればOK。<br />
何かを呼び出し元に返すには、&#8221;e.getChannel().write( {レスポンス} )&#8221;で。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">EchoServerHandler</span> <span class="k">extends</span> <span class="nc">SimpleChannelUpstreamHandler</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">logger</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="s">&quot;EchoServerHandler&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="k">val</span> <span class="n">transferredBytes</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// そのまま返す</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">messageReceived</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span><span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span><span class="kt">MessageEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transferredBytes</span><span class="o">.</span><span class="n">addAndGet</span><span class="o">(</span>
</span><span class="line">      <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">().</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">ChannelBuffer</span><span class="o">].</span><span class="n">readableBytes</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;echo_server: message received: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">())</span>
</span><span class="line">    <span class="c1">// レスポンスを返す</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">())</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// 例外発生時はここにくる</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">exceptionCaught</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">ExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="nc">WARNING</span><span class="o">,</span>
</span><span class="line">               <span class="s">&quot;Unexpected exception from downstream.&quot;</span><span class="o">,</span>
</span><span class="line">               <span class="n">e</span><span class="o">.</span><span class="n">getCause</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3>WebSocketサーバー</h3>
<p>本題のWebSocketサーバーです。<br />
Echoサーバーの応用で、WebSocket用のハンドラを作成して、Bootstrapに登録すれば良い訳です。</p>
<h4>仕様</h4>
<ul>
<li>WebSocketServer: 起動元</li>
<li>WebSocketServerHandler: プロトコルハンドラ。肝の部分。</li>
<li>WebSocketServerPipelineFactory: パイプライン生成。</li>
<li>WebSocketServeIndexPage: WebSocketクライアント用HTMLの生成</li>
</ul>
<h4>実装</h4>
<p>すべて書くと冗長なので要所だけ抜き出しました。<br />
<a href="https://github.com/ReSTARTR/nettyws/tree/master/src/main/scala/com/restartr/nettyws">全ソースはGithubを見てください。</a></p>
<p><b>WebSocketServerIndexPage.scala</b><br />
まずはクライアント側はこんな感じで、インプットフォームに入力した文字列をWebSocketサーバーに投げ、結果をdivに追記するだけです。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line">  <span class="k">var</span> <span class="n">socket</span><span class="o">;</span>
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">window</span><span class="o">.</span><span class="nc">WebSocket</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">socket</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WebSocket</span><span class="o">(</span> <span class="-Symbol">&#39;ws</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">8080</span><span class="kt">/uppercase</span><span class="err">&#39;</span> <span class="o">);</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onmessage</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="n">data</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onopen</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="-Symbol">&#39;web</span> <span class="n">socket</span> <span class="n">opened</span><span class="err">&#39;</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">    <span class="n">socket</span><span class="o">.</span><span class="n">onclose</span> <span class="k">=</span> <span class="n">function</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">{</span> <span class="n">log</span><span class="o">(</span><span class="-Symbol">&#39;web</span> <span class="n">socket</span> <span class="n">closed</span><span class="err">&#39;</span><span class="o">)</span> <span class="o">}</span>
</span><span class="line">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">    <span class="n">alert</span><span class="o">(</span><span class="-Symbol">&#39;your</span> <span class="n">browser</span> <span class="n">does</span> <span class="n">not</span> <span class="n">supported</span> <span class="n">web</span> <span class="n">socket</span><span class="err">&#39;</span><span class="o">)</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">function</span> <span class="n">log</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">p</span> <span class="k">=</span> <span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="o">(</span><span class="-Symbol">&#39;p</span><span class="err">&#39;</span><span class="o">);</span>
</span><span class="line">    <span class="n">p</span><span class="o">.</span><span class="n">innerHTML</span> <span class="k">=</span> <span class="n">message</span>
</span><span class="line">    <span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="o">(</span><span class="-Symbol">&#39;log</span><span class="err">&#39;</span><span class="o">).</span><span class="n">appendChild</span><span class="o">(</span><span class="n">p</span><span class="o">)</span> <span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="n">function</span> <span class="n">send</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">window</span><span class="o">.</span><span class="nc">WebSocket</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span><span class="o">;</span> <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="n">readyState</span> <span class="o">==</span> <span class="nc">WebSocket</span><span class="o">.</span><span class="nc">OPEN</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">alert</span><span class="o">(</span><span class="-Symbol">&#39;the</span> <span class="n">socket</span> <span class="n">is</span> <span class="n">not</span> <span class="n">open</span><span class="o">.</span><span class="err">&#39;</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServer.scala</b><br />
サーバー起動オブジェクトです。<br />
HTML/WebSocketを扱うハンドラを登録してポートで待ち受けます。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="c1">// WebSocket用ハンドラを含むPipelineFactoryを登録</span>
</span><span class="line"><span class="n">bootstrap</span><span class="o">.</span><span class="n">setPipelineFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebSocketServerPipelineFactory</span><span class="o">())</span>
</span><span class="line">
</span><span class="line"><span class="c1">// 8080番で待ち受け開始</span>
</span><span class="line"><span class="n">bootstrap</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">8080</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServerHandler.scala</b><br />
実装するのは、Echoサーバーと同じく、messageReceived()とexceptionCaught()の２つ。<br />
処理を分割しているのですこしだけメソッド多めです。<br />
messageRecieved()で受信内容によって実際のハンドラをHttp/WebSocketのどちらかに切り替えます。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="k">class</span> <span class="nc">WebSocketServerHandler</span> <span class="k">extends</span> <span class="nc">SimpleChannelUpstreamHandler</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="nc">WEBSOCKET_PATH</span> <span class="k">=</span> <span class="s">&quot;/uppercase&quot;</span>
</span><span class="line">
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * メッセージ受信時の処理</span>
</span><span class="line"><span class="cm">   *   メッセージの内容によってWebSocketかHttpかハンドラを切り替える</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">messageReceived</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">MessageEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">msg</span><span class="k">:</span><span class="kt">Object</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">()</span>
</span><span class="line">    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
</span><span class="line">      <span class="k">case</span> <span class="n">frame</span><span class="k">:</span> <span class="kt">WebSocketFrame</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">handleWebSocketFrame</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">frame</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">      <span class="k">case</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span> <span class="o">=&gt;</span> <span class="o">{</span>
</span><span class="line">          <span class="n">handleHttpRequest</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">req</span><span class="o">)</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * HTTPリクエスト時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">handleHttpRequest</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// DEBUG</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;handleHttpRequest: &quot;</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="n">currentThread</span><span class="o">().</span><span class="n">getName</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// GETリクエスト以外は処理しない</span>
</span><span class="line">    <span class="c1">// &quot;/&quot;にきたらWebSocketクライアント用ページを送信</span>
</span><span class="line">    <span class="c1">// &quot;/uppercase&quot;にきたらリクエスト文字列を大文字に変換して返す</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getMethod</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">GET</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">sendHttpResponse</span><span class="o">(</span>
</span><span class="line">        <span class="n">ctx</span><span class="o">,</span>
</span><span class="line">        <span class="n">req</span><span class="o">,</span>
</span><span class="line">        <span class="k">new</span> <span class="nc">DefaultHttpResponse</span><span class="o">(</span><span class="nc">HTTP_1_1</span><span class="o">,</span> <span class="nc">FORBIDDEN</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getUri</span><span class="o">().</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">    	
</span><span class="line">      <span class="c1">// (中略) デフォルトHTMLの送信</span>
</span><span class="line">
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getUri</span><span class="o">().</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="nc">WEBSOCKET_PATH</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">               <span class="nc">Values</span><span class="o">.</span><span class="nc">UPGRADE</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">Names</span><span class="o">.</span><span class="nc">CONNECTION</span><span class="o">))</span> <span class="o">&amp;&amp;</span>
</span><span class="line">               <span class="nc">Values</span><span class="o">.</span><span class="nc">WEBSOCKET</span><span class="o">.</span><span class="n">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">Names</span><span class="o">.</span><span class="nc">UPGRADE</span><span class="o">)))</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// (中略) WebSocket接続処理</span>
</span><span class="line">
</span><span class="line">      <span class="c1">// ハンドラをHTTPからWebSocketに切り替えて、</span>
</span><span class="line">      <span class="c1">// send the handshake response</span>
</span><span class="line">      <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">getPipeline</span><span class="o">()</span>
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="s">&quot;aggregator&quot;</span><span class="o">)</span>
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;decoder&quot;</span><span class="o">,</span> <span class="s">&quot;wsdecoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketFrameDecoder</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">      <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">res</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;encoder&quot;</span><span class="o">,</span> <span class="s">&quot;wsencoder&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketFrameEncoder</span><span class="o">())</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">      <span class="n">sendHttpResponse</span><span class="o">(</span>
</span><span class="line">        <span class="n">ctx</span><span class="o">,</span> <span class="n">req</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DefaultHttpResponse</span><span class="o">(</span><span class="nc">HTTP_1_1</span><span class="o">,</span> <span class="nc">FORBIDDEN</span><span class="o">))</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * WebSocketリクエスト時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">handleWebSocketFrame</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">frame</span><span class="k">:</span> <span class="kt">WebSocketFrame</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// 大文字に変換するして、WebSocketFrameにのせてレスポンスを返す。</span>
</span><span class="line">    <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span>
</span><span class="line">      <span class="k">new</span> <span class="nc">DefaultWebSocketFrame</span><span class="o">(</span>
</span><span class="line">        <span class="n">frame</span><span class="o">.</span><span class="n">getTextData</span><span class="o">().</span><span class="n">toUpperCase</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * HTTPレスポンスの送信</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">sendHttpResponse</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">,</span> <span class="n">res</span><span class="k">:</span> <span class="kt">HttpResponse</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// ステータスコードが200じゃなければエラーページの表示</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">getCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">res</span><span class="o">.</span><span class="n">setContent</span><span class="o">(</span>
</span><span class="line">        <span class="nc">ChannelBuffers</span><span class="o">.</span><span class="n">copiedBuffer</span><span class="o">(</span>
</span><span class="line">          <span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">toString</span><span class="o">(),</span> <span class="nc">CharsetUtil</span><span class="o">.</span><span class="nc">UTF_8</span><span class="o">))</span>
</span><span class="line">      <span class="nc">HttpHeaders</span><span class="o">.</span><span class="n">setContentLength</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="n">res</span><span class="o">.</span><span class="n">getContent</span><span class="o">().</span><span class="n">readableBytes</span><span class="o">())</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// keep-aliveでなければ接続を閉じる</span>
</span><span class="line">    <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">write</span><span class="o">(</span><span class="n">res</span><span class="o">)</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="n">isKeepAlive</span><span class="o">(</span><span class="n">req</span><span class="o">)</span> <span class="o">||</span> <span class="n">res</span><span class="o">.</span><span class="n">getStatus</span><span class="o">().</span><span class="n">getCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">200</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">f</span><span class="o">.</span><span class="n">addListener</span><span class="o">(</span><span class="nc">ChannelFutureListener</span><span class="o">.</span><span class="nc">CLOSE</span><span class="o">)</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * 例外発生時の処理</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">override</span> <span class="k">def</span> <span class="n">exceptionCaught</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">ChannelHandlerContext</span><span class="o">,</span> <span class="n">e</span><span class="k">:</span> <span class="kt">ExceptionEvent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">println</span><span class="o">(</span><span class="s">&quot;server: exception caught: &quot;</span><span class="o">)</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getCause</span><span class="o">().</span><span class="n">printStackTrace</span><span class="o">()</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="n">getChannel</span><span class="o">().</span><span class="n">close</span><span class="o">()</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">  <span class="cm">/**</span>
</span><span class="line"><span class="cm">   * WebSocket接続情報</span>
</span><span class="line"><span class="cm">   */</span>
</span><span class="line">  <span class="k">def</span> <span class="n">getWebSocketLocation</span><span class="o">(</span><span class="n">req</span><span class="k">:</span> <span class="kt">HttpRequest</span><span class="o">)</span> <span class="k">=</span>
</span><span class="line">    <span class="s">&quot;ws://&quot;</span> <span class="o">+</span> <span class="n">req</span><span class="o">.</span><span class="n">getHeader</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="nc">Names</span><span class="o">.</span><span class="nc">HOST</span><span class="o">)</span> <span class="o">+</span> <span class="nc">WEBSOCKET_PATH</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><b>WebSocketServerPipelineFactory.scala</b><br />
パイプラインへの登録を定義します。<br />
リクエストはDecoderを通り、ハンドラで処理され、Encoderを通って返される、という流れです。<br />
ここでは初期状態としてHttp用の設定になっていますが、一旦WebSocket通信開始のリクエストを受け取ると、そのあとはWebSocketのDecoder/Encoderに切り替わります。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="scala"><span class="line"><span class="o">&lt;</span><span class="n">pre</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;brush:scala&quot;</span><span class="o">&gt;</span>
</span><span class="line"><span class="k">class</span> <span class="nc">WebSocketServerPipelineFactory</span> <span class="k">extends</span> <span class="nc">ChannelPipelineFactory</span><span class="o">{</span>
</span><span class="line">  <span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
</span><span class="line">  <span class="k">def</span> <span class="n">getPipeline</span><span class="o">()</span><span class="k">:</span> <span class="kt">ChannelPipeline</span> <span class="o">=</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="nc">Channels</span><span class="o">.</span><span class="n">pipeline</span><span class="o">()</span>
</span><span class="line">
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;decoder&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpRequestDecoder</span><span class="o">())</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;aggregator&quot;</span> <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpChunkAggregator</span><span class="o">(</span><span class="mi">65536</span><span class="o">))</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;encoder&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">HttpResponseEncoder</span><span class="o">())</span>
</span><span class="line">    <span class="n">pipeline</span><span class="o">.</span><span class="n">addLast</span><span class="o">(</span><span class="s">&quot;handler&quot;</span>    <span class="o">,</span> <span class="k">new</span> <span class="nc">WebSocketServerHandler</span><span class="o">())</span>
</span><span class="line">
</span><span class="line">    <span class="n">pipeline</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>実際、ブラウザでひらいてみると、Webフォームに入力されている「hello, world」が大文字に変換されてフォーム下部に追記されていきます。<br />
まぁWebSocketサーバーを実装するだけなら、jetty7を使ったほうがシンプルに早くかけると思います。<br />
Memcacheプロトコルを話すサービスをつくる場合とかには便利ですね。（messagepack-rpcでもnetty使っているとか。)</p>

<p>参考：</p>

<ul>
  <li><a href="http://gihyo.jp/dev/feature/01/websocket">Jettyで始めるWebSocket超入門</a></li>
  <li><a href="http://d.hatena.ne.jp/yuroyoro/20100316/1268735022">Jetty7のWebSocketをScalaから使う - ゆろよろ日記</a></li>
</ul>

<p>以上、お粗末様でした。。。</p>
<p># あれ？Scalaあんまり関係ない？？</p>
</div>
  
  




    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/11/23/scala-erlang-php-and-me/">ScalaとErlangとPHPと私</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-11-23T18:57:35+09:00" pubdate data-updated="true">2010-11-23 (Tue)</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>PHPよりScalaが簡単である、という議論に対するふたつのポストがあったので、自分向けにまとめました。</p>
<ul>
<li>元記事：<a href="http://wadearnold.com/blog/scala/scala-is-easier-than-php">Wade Arnold ? Scala is easier than PHP</a></li>
<li>返信：<a href="http://videlalvaro.github.com/2010/11/reply-to-scala-is-easier-than-php.html">Reply to &#8220;Scala is Easier than PHP&#8221;</a></li>
</ul>
<h3>概要</h3>
<p>ざっとこんな感じにまとめてしまいました。</p>
<ul>
<li>議論の中心はWebページ生成言語としての言語の比較ではない</li>
<li>ふたりともWebページ生成ならPHPが優れているという立場にかわりはない</li>
<li>議論の中心は主にスケーラビリティの確保とプロセス間通信</li>
<li>元記事のWade ArnoldさんはScala推進派</li>
<li>返信者のvidelalvaroさんはErlang推進派</li>
<li>スケーラビリティ確保のためには関数型言語という結論</li>
<li>ScalaかErlangどちらが簡単か、という議論はない</li>
</ul>
<p><a id="more"></a><a id="more-410"></a></p>
<h3>ScalaがPHPより簡単な理由</h3>
<p>Wade Arnoldさんが元記事「Scala is easier than PHP」において、マルチコア時代にはScalaが必要だ、みたいなことを書きました。彼はPHP３のころからPHPの開発に関わっていて、最近はZendFrameworkのコミッタをやっていたそうです。<br />
PHPはいまだに最高の言語であると最初に断っておきつつ、Scalaの技術的な点を整理しておこう、という内容。</p>
<p>スケーラビリティの確保のためには、PHPのようにたくさんのツールを必要とせずとも、言語仕様的に多くをサポートするScalaが簡単な理由である、と。Scalaへの移行は時間を必要とするが、スケーラビリティには必要な選択であるといっています。</p>
<blockquote><p>No need for amqp with actors, no beanstalkd with mutable queues, and it’s fast as hell!</p></blockquote>
<p><em>ActorによってAMQPはいらなくなる。ミュータブルなキューもbeanstalkdなしに。そしてそれはものすごく速い。<br />
</em></p>
<h3>PHPの代わりにErlangを使う理由</h3>
<p>それに対してvidelalvaroさんが「Reply to &#8220;Scala is easier than PHP&#8221;」でコメントをしています。<br />
おおむねWadeさんの意見に同意で、彼はScalaではなくErlangを推しているようです。</p>
<p>意見としてはこんな感じでしょうか。</p>
<ul>
<li>サーバーのような長時間実行するプログラムにはErlangつかうといい</li>
<li>スレッド間通信にはErlangをつかうといい</li>
<li>Webページを生成するだけならPHPをつかうといい</li>
<li>CPUの全コアを利用したいだけならPHP-FPMをつかうといい</li>
</ul>
<h3>スケーラビリティ確保のために必要なもの</h3>
<p>元記事ではPHPのスケーラビリティ確保のために必要なものをあげ、これらを使うのは大変骨が折れると言っています。</p>
<blockquote>
<ul>
<li>Fantastic at PHP internals</li>
<li>Amazing at Apache HTTPD and compiling appropriate PHP extensions.</li>
<li>Nginx</li>
<li>BigIP ? More than round robin load balancing</li>
<li>Intimately know how sessions work and probably write your own handlers</li>
<li>Memcached</li>
<li>APC</li>
<li>AMQP</li>
<li>BeanStalkd</li>
<li>Code based sharding or at least master/slave logic</li>
<li>C/C++</li>
<li>Lots of security! It’s a problem with all dynamic languages.</li>
<li>Zend Framework.</li>
</ul>
</blockquote>
<p>それに対してScalaはたった５つ。</p>
<blockquote>
<ul>
<li>6 months of scala</li>
<li>Functional programming</li>
<li><a onclick="javascript:_gaq.push(['_trackEvent','outbound-article','akkasource.org']);" href="http://akkasource.org/">Akka Framework</a></li>
<li><a onclick="javascript:_gaq.push(['_trackEvent','outbound-article','liftweb.net']);" href="http://liftweb.net/">Lift Framework</a></li>
<li>Nginx / Jetty</li>
</ul>
</blockquote>
<p>ツールに頼らずとも言語が機能を備えているから気にすべきところが非常にシンプルになるようです。</p>
<h3>個人的感想</h3>
<p>PHPをWebページ生成以外で対決させるのはどうなんだろうと思いつつも、Scalaをどのような場面で使っていけばよいか考える良い機会になりました。<br />
個人的な話をすると、Scalaは言語仕様を学ぶばかりで実際のプログラムを書くまでには至っていませんし、性能評価もまだやってないので「PHPからScalaに移行すべきだ」、と言い切るには至っていないのが現状です。<br />
が、Wadeさんは後ほどもっと突っ込んだ記事を書くと冒頭に言っていますし、videlalvaroさんも最後に</p>
<blockquote><p>if we want to sell functional languages like Erlang or Scala to the PHP programmer then we have to look for more compelling features that may attract them to look into these languages. What I think are those features ?I guess?, should be part of another blog post.</p></blockquote>
<p>と、ScalaやErlangをPHPerに売り込むための魅力的な点をPOSTしてくれるかも。<br />
それも楽しみにしておこうと思います。</p>
<h3>余談</h3>
<p>最近思うのが、Scalaって言語仕様があまりに多くて、それを学ぶことが楽しいです。<br />
が、学ぶべき仕様がどこまでなのか見えてこず、さらに、仕様を学ぶこと自体が目的になってきているような気がします。<br />
ということで(?)そろそろ、実際につくりたいプログラムを書きながら仕様を学ぶ方向にシフトしようと思います。</p>
<p>※あとPHP-FPMもちゃんと調査・検証したいし、Kestrelのソースも読みたい。</p>
</div>
  
  




    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/26/">&larr; Older</a>
    
    <a href="/blog/archives/"> Archives </a>
    
    <a class="next" href="/page/24/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section id="titles">
  <a href="http://blog.restartr.com" title="I Will Survive"><img id="logo" src="http://blog.restartr.com/images/portrait.jpg" /></a>
  <h1 id="site_title"><a href="http://blog.restartr.com" title="I Will Survive">I Will Survive</a></h1>
  <h3 id="site_subtitle">An application depelopper&#8217;s blog.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://blog.restartr.com"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://blog.restartr.com/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://blog.restartr.com/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://blog.restartr.com/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  
    <a href="" title="g+#103216164658230535238"><i class="fa fa-google-plus fa-2x"></i></a>
  

  
    <a href="https://github.com/ReSTARTR" title="ReSTARTR"><i class="fa fa-github fa-2x"></i></a>
  

  

  
    <a href="https://twitter.com/ReSTARTR" title="ReSTARTR"><i class="fa fa-twitter fa-2x"></i></a>
  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2015/01/18/peek-for-profiling-rails-app/">Peek - Railsアプリのプロファイリングツール</a>
      </li>
    
      <li class="post">
        <a href="/2014/12/31/books-2014/">2014年に購入した技術書</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/20/microservices-architecture/">InfoQ eMAG: Microservicesを少し読んだまとめと感想</a>
      </li>
    
      <li class="post">
        <a href="/2014/08/13/golang-json-marshal-unmarshal/">Goのjson.Marshal/Unmarshalの仕様を整理してみる</a>
      </li>
    
      <li class="post">
        <a href="/2014/06/28/about-docker-libchan/">Docker謹製ライブラリのlibchanについて調べてみた</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
  <ul id="categories">
    <li><a href='/category/architecture/'>architecture</a></li><li><a href='/category/docker/'>docker</a></li><li><a href='/category/gadget/'>gadget</a></li><li><a href='/category/go/'>go</a></li><li><a href='/category/golang/'>golang</a></li><li><a href='/category/hadoop/'>hadoop</a></li><li><a href='/category/php/'>PHP</a></li><li><a href='/category/python/'>python</a></li><li><a href='/category/ruby/'>ruby</a></li><li><a href='/category/scala/'>Scala</a></li><li><a href='/category/varnish/'>varnish</a></li><li><a href='/category/vim/'>vim</a></li><li><a href='/category/websabisu/'>Webサービス</a></li><li><a href='/category/detamainingu/'>データマイニング</a></li><li><a href='/category/puroguramingu/'>プログラミング</a></li><li><a href='/category/ru-men-zi-ran-yan-yu-chu-li/'>入門 自然言語処理</a></li><li><a href='/category/shu-ji/'>書籍</a></li><li><a href='/category/za-ji/'>雑記</a></li>
  </ul>
</section>
<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ReSTARTR">@ReSTARTR</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ReSTARTR',
            count: 4,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/103216164658230535238?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - ReSTARTR -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
